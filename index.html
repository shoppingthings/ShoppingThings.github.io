<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>ShoppingThings — Smart Home IoT Checklist</title>
  
  <!-- Libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
  
  <!-- Tailwind Config -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            brand: { DEFAULT: '#008DF7', dark: '#006BEA', light: '#68AEFF' },
            surface: { DEFAULT: 'rgba(255,255,255,0.64)', strong: 'rgba(255,255,255,0.98)' }
          },
          fontFamily: {
            sans: ['"Noto Sans KR"', 'sans-serif'],
            display: ['"Noto Sans KR"', 'sans-serif'],
            logo: ['SamsungSharpSans', 'sans-serif'],
          },
          keyframes: {
            marquee: {
              '0%': { transform: 'translateX(0)' },
              '10%': { transform: 'translateX(0)' },
              '45%': { transform: 'translateX(calc(-100% + 100px))' },
              '55%': { transform: 'translateX(calc(-100% + 100px))' },
              '100%': { transform: 'translateX(0)' },
            },
            slideUp: {
              '0%': { transform: 'translateY(100%)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' }
            },
            slideDown: {
              '0%': { transform: 'translateY(-20px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' }
            },
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' }
            }
          },
          animation: {
            marquee: 'marquee 8s linear infinite',
            slideUp: 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
            slideDown: 'slideDown 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
            fadeIn: 'fadeIn 0.2s ease-out',
          }
        }
      }
    }
  </script>

  <!-- Custom Styles -->
  <style>
    
    /* disable horizontal scroll*/
    html{
      max-width : 100%;
      overflow-x: hidden;
    }
    /* Custom Fonts */
    @font-face {
      font-family: 'SamsungSharpSans';
      src: url('fonts/SamsungSharpSans-Bold.TTF');
      font-weight: bold;
      font-style: normal;
      font-display: swap;
    }

    /* Hide scrollbars */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* Glassmorphism */
    .glass {
      background: rgba(255, 255, 255, 0.65);
      backdrop-filter: blur(14px) saturate(120%);
      border: 1px solid rgba(255, 255, 255, 0.5);
    }
    .dark .glass {
      background: rgba(15, 23, 42, 0.65);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* Hide Number Input Spinners */
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }

    /* Print Hiding */
    @media print {
      .no-print { display: none !important; }
    }

    /* Dark Mode Ambient Light Gradient */
    body.dark {
      background-image: radial-gradient(ellipse at top, #002f53 0%, #0f172a 50%, #020617 100%);
    }

    /* Mask for tabs */
    .mask-linear-sides {
      mask-image: linear-gradient(to right, transparent, black 20px, black calc(100% - 20px), transparent);
      -webkit-mask-image: linear-gradient(to right, transparent, black 20px, black calc(100% - 20px), transparent);
    }

    /* Notification Stack Styles */
    #notif-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(2px);
      z-index: 90;
      display: none;
    }
    #notif-backdrop.active { display: block; }

    .notif-stack {
      position: fixed;
      top: 72px; /* Below GNB */
      right: 16px; /* Align with GNB content approx */
      z-index: 100;
      width: 340px;
      max-width: calc(100vw - 32px);
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      transform-origin: top right;
      transition: all 0.2s ease-out;
      opacity: 0;
      pointer-events: none;
      transform: scale(0.95);
    }
    .notif-stack.open {
      opacity: 1;
      pointer-events: auto;
      transform: scale(1);
    }
    
    .stack-card {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(0,0,0,0.08);
      box-shadow: 0 10px 40px -10px rgba(0,0,0,0.15);
      border-radius: 16px;
      width: 100%;
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .dark .stack-card {
      background: rgba(30, 41, 59, 0.98);
      border: 1px solid rgba(255,255,255,0.1);
      color: white;
    }

    .notif-stack.folded .stack-preview {
      position: absolute;
      bottom: -6px;
      left: 10px;
      right: 10px;
      height: 10px;
      background: white;
      opacity: 0.5;
      border-radius: 0 0 12px 12px;
      z-index: -1;
      transform: scale(0.95);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .dark .notif-stack.folded .stack-preview { background: #334155; }
    
    .notif-stack.folded .stack-preview:nth-child(2) {
      bottom: -12px;
      transform: scale(0.9);
      opacity: 0.3;
      z-index: -2;
    }

    /* Bell Button specific */
    .nudge-dot {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background-color: #EF4444;
      border: 1px solid white;
      display: none;
    }
    .dark .nudge-dot { border-color: #0f172a; }
    
    button[aria-pressed="true"] {
      color: #008DF7;
      background-color: rgba(0, 141, 247, 0.1);
    }

    .severity-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 8px; }
    .severity-dot.critical { background-color: #EF4444; box-shadow: 0 0 8px rgba(239,68,68,0.5); }
    .severity-dot.major { background-color: #F97316; }
    .severity-dot.minor { background-color: #EAB308; }
    .severity-dot.info { background-color: #3B82F6; }
    .severity-dot.success { background-color: #22c55e; }
    
    /* marquee for widget */
    .marquee {
      position: relative;
      overflow: hidden;
      width: 100%;
      display: block;
    }

    .marquee__inner {
      display: inline-flex;
      white-space: nowrap;
      align-items: center;
      will-change: transform;
    }

    @keyframes marquee-slide {
      from { transform: translateX(0); }
      to   { transform: translateX(calc(var(--marquee-translate, 0px) * -1)); }
    }

    .marquee:hover .marquee__inner,
    .marquee:focus-within .marquee__inner {
      animation-play-state: paused;
    }

    @media (prefers-reduced-motion: reduce) {
      .marquee__inner {
        animation: none !important;
      }
    }

    /* Slider Styles */
    .slider-container {
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
    }
    .slider-slide {
      scroll-snap-align: center;
    }
    
    
    /* app-store-grid: vertical breathing room + smoother snap behavior */
    #app-store-grid {
      display: flex;
      gap: 1rem;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x proximity;
      scroll-behavior: smooth;
      padding-top: 20px;
      padding-bottom: 40px;
      scroll-padding-inline: 50px;
      align-items: flex-start;
    }

    #app-store-grid > * {
      scroll-snap-align: center;
      -webkit-user-drag: none;
    }

    #app-store-grid .group,
    #app-store-grid .shrink-0 { 
      overflow: visible;
    }
    /* Toast Notification styles */
    #toast-container {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      align-items: center;
      pointer-events: none;
    }
    .st-toast {
      background: #333;
      color: white;
      padding: 12px 20px;
      border-radius: 12px;
      margin-top: 10px;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      pointer-events: auto;
      max-width: 90vw;
    }
    .st-toast.show {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>
<body class="text-slate-900 dark:text-slate-100 antialiased overflow-x-hidden transition-colors duration-500 bg-gradient-to-br from-slate-50 via-white to-blue-50 dark:from-slate-950 dark:via-slate-900 dark:to-[#0B1121]">
  
  <!-- GNB -->
  
  <header id="gnb" class="fixed top-0 left-0 right-0 bg-white/80 dark:bg-slate-900/80 glass border-b border-slate-200/50 dark:border-slate-800 z-50 no-print-target backdrop-blur-md flex flex-col transition-transform duration-300">
    <!-- Row 1 -->
    <div class="flex items-center justify-between px-4 h-16 w-full max-w-7xl mx-auto">
      <div class="flex items-center gap-3">
        <button id="btn-sidebar-toggle" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg hidden md:flex text-slate-500 dark:text-slate-400 transition-colors"></button>
        <div class="w-10 h-10 flex items-center justify-center overflow-hidden">
          <img src="images/icons/general/logo_shoppingthings_512h.png" alt="ShoppingThings" class="w-full h-full object-cover" onerror="this.style.display='none';this.parentElement.innerText='ST'">
        </div>
        <h1 class="font-logo font-bold text-lg tracking-wide text-slate-900 dark:text-white pt-0.5">ShoppingThings</h1>
      </div>

      <!-- PC Tabs -->
      <div class="hidden md:flex items-center gap-4 overflow-hidden flex-1 px-8 justify-start">
        <div id="pc-tabs-container" class="flex items-center gap-2 overflow-x-auto no-scrollbar mask-linear-sides w-full cursor-grab active:cursor-grabbing select-none"></div>
      </div>

      <!-- Actions -->
      <div class="flex items-center gap-2 shrink-0">
        <div class="flex items-center">
          <button id="btn-gnb-notif" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full text-slate-500 dark:text-slate-400 transition-colors relative" aria-label="알림" aria-pressed="false">
             <span class="nudge-dot"></span>
          </button>
          <div class="relative">
            <button id="btn-gnb-more" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full text-slate-500 dark:text-slate-400 transition-colors"></button>
          </div>
        </div>
      </div>
    </div>

    <!-- Row 2: Mobile Tabs -->
    <div class="md:hidden border-t border-slate-100 dark:border-slate-800 px-2 py-2 bg-white/50 dark:bg-slate-900/50 backdrop-blur-sm" id="mobile-tabs-wrapper">
      <div id="mobile-tabs-container" class="flex items-center gap-2 overflow-x-auto no-scrollbar w-full cursor-grab active:cursor-grabbing select-none"></div>
    </div>
  </header>

  <!-- Layout -->
  <div class="pt-32 md:pt-20 flex max-w-7xl mx-auto px-4 gap-6">
    <!-- Sidebar -->
    <aside id="sidebar" class="fixed top-24 bottom-4 bg-transparent transition-all duration-300 z-30 hidden md:flex flex-col gap-2 no-print-target w-48">
      <nav class="flex flex-col gap-1 w-full">
        <button id="nav-device" class="flex items-center gap-3 rounded-xl border shadow-sm transition-all text-left px-4 py-3 bg-white/50 dark:bg-slate-800/50 hover:bg-white dark:hover:bg-slate-800 text-brand border-slate-100 dark:border-slate-700 font-bold">
          <span>기기</span>
        </button>
        <button id="nav-help" class="flex items-center gap-3 rounded-xl border border-transparent transition-all text-left px-4 py-3 hover:bg-white/50 dark:hover:bg-slate-800/50 text-slate-500 dark:text-slate-400 hover:border-slate-100 dark:hover:border-slate-700 font-bold">
          <span>도움말</span>
        </button>
      </nav>
    </aside>

    <!-- Main Content -->
    <main id="main-content" class="flex-1 transition-all duration-300 min-w-0 md:ml-52">
      
      <!-- View: Checklist -->
      <div id="view-checklist" class="w-full transition-opacity duration-300">
        <!-- Map View Widget -->
        <div id="map-view-area" class="w-full mb-8 scroll-mt-32"></div>

        
        <!-- Progressive Automation Score Widget -->
        <div id="pas-wrapper" class="w-full mb-8 cursor-pointer select-none group" title="클릭하여 상세 분석 보기">
          
          <div class="relative w-full h-10 bg-slate-200 dark:bg-slate-700 rounded-xl overflow-hidden shadow-inner border border-slate-200 dark:border-slate-600">
             <div class="absolute left-[33%] top-0 bottom-0 w-[2px] bg-white dark:bg-slate-800 z-10 opacity-30"></div>
             <div class="absolute left-[66%] top-0 bottom-0 w-[2px] bg-white dark:bg-slate-800 z-10 opacity-30"></div>
             <div id="pas-fill" class="h-full bg-brand transition-all duration-1000 ease-out relative w-0 flex items-center justify-end px-3">
                <div class="absolute inset-0 bg-gradient-to-b from-white/20 to-transparent"></div>
             </div>
          </div>
          <div class="flex items-end justify-between mb-2 px-1">
            <div class="flex flex-col">
              <div class="flex items-baseline gap-1 mt-1">
                <span id="pas-val" class="text-4xl font-black text-slate-800 dark:text-white leading-none tracking-tight">0</span>
                <span class="text-lg font-bold text-slate-400">/ 100</span>
              </div>
              <div class="flex items-baseline gap-2">
                <span class="text-sm font-extrabold text-slate-500 dark:text-slate-400 uppercase tracking-widest">Automation Score</span>
              </div>
            </div>
            <div class="flex flex-col items-end">
               <div id="pas-status-text" class="text-3xl font-black text-slate-300 dark:text-slate-600 mb-1">분석 중</div>
               <div id="pas-desc" class="text-xs font-bold text-slate-400 text-right">잠시만 기다려주세요</div>
            </div>
          </div>
          
        </div>
        <!-- Automation Widgets (New) -->
        <div id="automation-widgets-area" class="w-full mb-8"></div>
        <div id="widgets-area" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 w-full mb-6"></div>
        <div id="rooms-area" class="flex flex-col gap-6"></div>
      </div>

      <!-- View: Help (One-Page Structure) -->
      <div id="view-help" class="hidden w-full pb-12 space-y-12 animate-fadeIn">
        
        <!-- 1. Tutorial Hero -->
        <section class="relative overflow-hidden bg-gradient-to-r from-brand-dark to-brand rounded-[2.5rem] p-8 md:p-14 flex flex-col md:flex-row items-center justify-between shadow-2xl shadow-brand/30 isolate">
          <div class="absolute -top-32 -right-32 w-80 h-80 bg-white/10 rounded-full blur-3xl -z-10 pointer-events-none"></div>
          <div class="absolute -bottom-32 -left-32 w-80 h-80 bg-blue-400/20 rounded-full blur-3xl -z-10 pointer-events-none"></div>
          <div class="absolute right-10 top-10 text-white/5 pointer-events-none">
            <svg width="200" height="200" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
          </div>

          <div class="flex flex-col items-center md:items-start text-center md:text-left z-10 max-w-xl">
            <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/10 border border-white/20 text-blue-50 text-xs font-bold uppercase tracking-wider mb-6 backdrop-blur-sm">
              <span class="w-2 h-2 rounded-full bg-blue-300 animate-pulse"></span> Start Guide
            </div>
            <h2 class="text-3xl md:text-5xl font-black text-white mb-6 leading-tight tracking-tight drop-shadow-sm">
              <span class="font-logo font-bold tracking-wide text-slate-900 text-white pt-0.5">ShoppingThings</span><br/>
              <span class="opacity-90 font-light">가이드북</span>
            </h2>
            <p class="text-blue-50 text-lg mb-10 font-medium leading-relaxed max-w-md">
              스마트홈이 처음이신가요?<br class="md:hidden"/> 30초 튜토리얼로<br class="hidden md:inline"/> 스마트홈 쇼핑리스트 제작을 마스터하세요.
            </p>
            <button onclick="TutorialController.open()" class="group px-8 py-3.5 bg-white text-brand-dark rounded-full font-bold text-lg shadow-xl shadow-black/10 hover:shadow-white/20 hover:scale-105 transition-all flex items-center gap-3 active:scale-95">
               <span>튜토리얼 시작하기</span>
               <svg class="w-5 h-5 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
            </button>
          </div>
          
          <div class="mt-12 md:mt-0 relative z-10 hidden md:block">
            <div class="w-56 h-56 bg-gradient-to-tr from-white/20 to-white/5 backdrop-blur-lg rounded-[2rem] border border-white/20 flex items-center justify-center shadow-2xl transform rotate-6 hover:rotate-3 transition-transform duration-500">
               <div class="text-white drop-shadow-2xl">
                   <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
               </div>
            </div>
          </div>
        </section>

        <!-- 2. App Install (Redesigned) -->
        <section class="max-w-6xl mx-auto w-full">
          <div class="mb-8">
            <h3 class="text-2xl font-bold text-slate-900 dark:text-white mb-2">스마트싱스로 시작하세요</h3>
            <p class="text-slate-500 dark:text-slate-400 mb-6">이제 내 기기가 스마트홈의 컨트롤러로 바뀝니다. <span class="font-logo font-bold tracking-wide text-slate-900 dark:text-white pt-0.5">SmartThings</span>를 지금 다운로드하세요. </p>
            
            <!-- Filter Tabs -->
            <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2" id="app-filter-tabs">
               <!-- JS Generated -->
            </div>
          </div>
          
          <!-- Horizontal Scroll Grid -->
          <div id="app-store-grid" class="flex gap-4 overflow-x-auto no-scrollbar pb-6 snap-x snap-mandatory">
            <!-- JS Injected -->
          </div>
        </section>

        <!-- 3. Community (Redesigned) -->
        <section class="max-w-6xl mx-auto w-full grid grid-cols-1 md:grid-cols-3 gap-6">
            
            <!-- Gallery -->
            <a href="https://gall.dcinside.com/mgallery/board/lists/?id=smartthings" target="_blank" class="group relative overflow-hidden bg-slate-900 rounded-[2rem] p-8 min-h-[320px] flex flex-col justify-between shadow-lg hover:shadow-2xl hover:scale-[1.02] transition-all duration-300 col-span-1 md:col-span-2">
                <div class="absolute inset-0 bg-gradient-to-br from-purple-600/30 to-blue-600/30 group-hover:opacity-100 transition-opacity"></div>
                <div class="absolute -right-10 -top-10 text-white/5 group-hover:text-white/10 transition-colors transform group-hover:rotate-12 duration-500">
                     <svg width="240" height="240" viewBox="0 0 24 24" fill="currentColor"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                </div>
                <div class="relative z-10">
                    <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/10 text-white text-xs font-bold mb-4 backdrop-blur-md">COMMUNITY</div>
                    <h3 class="text-3xl md:text-4xl font-black text-white mb-3 leading-tight">스마트싱스<br>갤러리</h3>
                    <p class="text-slate-300 font-medium max-w-sm">대한민국 스마트홈 유저들의<br>생생한 아이디어와 팁을 만나보세요.</p>
                </div>
                <div class="relative z-10 flex justify-end">
                    <span class="w-12 h-12 rounded-full bg-white/20 backdrop-blur-md flex items-center justify-center text-white group-hover:bg-white group-hover:text-slate-900 transition-colors">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                    </span>
                </div>
            </a>

            <div class="flex flex-col gap-6 col-span-1">
                 <!-- Notion -->
                <a href="https://gall.dcinside.com/mgallery/board/view/?id=smartthings&no=407&search_head=10&page=1" target="_blank" class="group relative overflow-hidden bg-[#FFF8F0] dark:bg-orange-950/30 rounded-[2rem] p-8 flex-1 shadow-sm hover:shadow-xl hover:scale-[1.02] transition-all border border-orange-100 dark:border-orange-900/50">
                     <div class="absolute -right-6 -bottom-6 text-orange-500/10 dark:text-orange-500/20 group-hover:scale-110 transition-transform duration-500">
                         <svg width="140" height="140" viewBox="0 0 24 24" fill="currentColor"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
                     </div>
                     <div class="relative z-10">
                         <h3 class="text-xl font-black text-slate-900 dark:text-white mb-1 group-hover:text-orange-600 dark:group-hover:text-orange-400 transition-colors">기초 가이드</h3>
                         <p class="text-sm text-slate-500 dark:text-slate-400 font-medium">Matter, Zigbee 개념잡기</p>
                     </div>
                </a>

                <!-- CleanThings -->
                <a href="https://cleanthings.github.io/" target="_blank" class="group relative overflow-hidden bg-blue-50 dark:bg-blue-950/30 rounded-[2rem] p-8 flex-1 shadow-sm hover:shadow-xl hover:scale-[1.02] transition-all border border-blue-100 dark:border-blue-900/50">
                     <div class="absolute -right-6 -bottom-6 text-blue-500/10 dark:text-blue-500/20 group-hover:scale-110 transition-transform duration-500">
                         <svg width="140" height="140" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>
                     </div>
                     <div class="relative z-10">
                         <h3 class="text-xl font-black text-slate-900 dark:text-white mb-1 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">인증된 제품</h3>
                         <p class="text-sm text-slate-500 dark:text-slate-400 font-medium">CleanThings 호환성 체크</p>
                     </div>
                </a>
            </div>
        </section>
      </div>
      
      <!-- Common Encouragement & Footer -->
      <section id="common-footer-section" class="mt-20 pb-32 md:pb-12 no-print">
         <div class="text-center ">
            <div class="p-8 rounded-[2rem] bg-blue-50/50 dark:bg-slate-800/50 border border-blue-100 dark:border-slate-270 backdrop-blur-sm">
               <h4 class="text-xl font-black text-slate-800 dark:text-white mb-3">쇼핑 리스트를 다 만드셨나요?</h4>
               <p class="text-slate-500 dark:text-slate-400 text-sm mb-6 leading-relaxed">
                  멋진 쇼핑 리스트를 저장하고<br>
                  스마트싱스 갤러리에 공유하여 IoT 제품을 추천받아 보세요.
               </p>
               <div class="flex justify-center gap-3">
                  <button id="btn-footer-png" class="px-5 py-2.5 bg-white dark:bg-slate-700 shadow-sm border border-slate-200 dark:border-slate-600 rounded-full text-sm font-bold text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-600 transition-colors">이미지로 저장</button>
                  <a href="https://gall.dcinside.com/mgallery/board/lists/?id=smartthings" target="_blank" class="px-5 py-2.5 bg-brand/10 text-brand rounded-full text-sm font-bold hover:bg-brand/20 transition-colors">스싱갤</a>
               </div>
            </div>
            
            <footer class="text-slate-400 dark:text-slate-600 text-sm font-logo font-bold p-8">
              &copy; 2026 PlusThings
            </footer>
         </div>
      </section>

    </main>

    <!-- Right Indicator -->
    <div id="indicator-area" class="fixed right-2 xl:right-4 top-1/2 -translate-y-1/2 flex flex-col gap-3 z-40 no-print-target pointer-events-none transition-opacity duration-300"></div>
  </div>

  <!-- Notification Backdrop -->
  <div id="notif-backdrop"></div>

  <!-- Notification Stack -->
  <div id="notif-stack" class="notif-stack no-print-target">
    <!-- Injected by JS -->
  </div>
  
  <!-- Tutorial Modal -->
  <div id="tutorial-modal" class="fixed inset-0 z-[100] hidden bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
     <div class="bg-white dark:bg-slate-900 rounded-3xl w-full max-w-lg overflow-hidden shadow-2xl relative flex flex-col max-h-[90vh]">
        <!-- Header -->
        <div class="p-4 flex justify-end">
           <button onclick="TutorialController.close()" class="p-2 text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
        </div>
        
        <!-- Slides -->
        <div id="tuto-slider" class="flex-1 overflow-hidden relative">
           <div id="tuto-track" class="flex transition-transform duration-300 ease-out h-full">
              <!-- Slides Injected by JS -->
           </div>
        </div>

        <!-- Controls -->
        <div class="p-8 flex items-center justify-between shrink-0">
           <div id="tuto-dots" class="flex gap-2"></div>
           <div class="flex gap-3">
              <button id="tuto-prev" onclick="TutorialController.prev()" class="hidden px-4 py-2 text-slate-500 font-bold hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl">이전</button>
              <button id="tuto-next" onclick="TutorialController.next()" class="px-6 py-2 bg-brand text-white font-bold rounded-xl shadow-lg shadow-brand/20">다음</button>
           </div>
        </div>
     </div>
  </div>

  <!-- Mobile FAB -->
  <button id="btn-export-mobile" class="fixed right-4 bottom-28 z-50 bg-gradient-to-r from-brand-light to-brand text-white pl-4 pr-4 py-3 rounded-full shadow-2xl shadow-brand/40 flex items-center gap-2 active:scale-95 transition-transform no-print-target">
    <span class="font-bold text-sm">이미지로 저장</span>
  </button>
  <button id="btn-tuto-mobile" onclick="TutorialController.open()" class="hidden fixed right-4 bottom-28 z-50 bg-gradient-to-r from-brand-light to-brand text-white pl-4 pr-4 py-3 rounded-full shadow-2xl shadow-brand/40 flex items-center gap-2 active:scale-95 transition-transform no-print-target">
    <span class="font-bold text-sm">튜토리얼</span>
  </button>

  <!-- Mobile Bottom Nav -->
  <nav class="md:hidden fixed bottom-4 left-4 right-4 bg-white/80 dark:bg-slate-900/80 glass border border-white/50 dark:border-slate-700 shadow-2xl rounded-2xl p-2 flex justify-around z-40 no-print-target">
    <button id="mobile-nav-device" class="flex flex-col items-center gap-1 p-2 text-brand">
      <span class="text-[10px] font-bold">기기</span>
    </button>
    <button id="mobile-nav-help" class="flex flex-col items-center gap-1 p-2 text-slate-400 dark:text-slate-500 active:text-brand">
      <span class="text-[10px] font-bold">도움말</span>
    </button>
  </nav>

  <!-- Portals -->
  <div id="modal-root"></div>
  <div id="popover-root"></div>
  <div id="autocomplete-root"></div>
  <!-- Main Script -->
  <script>
    // --- DATA CONSTANTS ---
    const STORAGE_KEY = 'shoppingthings:rooms:v9';
    const DEVICE_CATEGORIES = ['생활 가전', '에어케어 가전', '주방 가전', 'TV/엔터테인먼트', '조명/스위치', '에너지', '센서/보안', '허브/연결', '웨어러블', '피트니스/헬스', '라이프스타일/기타'];
    const DEVICE_PROFILE = {
      '생활 가전': ['건조기', '로봇청소기', '미세플라스틱 필터', '세탁기', '슈드레서', '스틱 청소기', '에어드레서'],
      '에어케어 가전': ['가습기', '공기청정기', '송풍/환기', '에어컨', '제습기'],
      '주방 가전': ['냉장고', '레인지', '식기세척기', '오븐', '전기밥솥', '전자레인지', '정수기', '쿡탑', '후드'],
      'TV/엔터테인먼트': ['AV 리시버', 'TV', '디스플레이', '모니터', '사운드바', '스피커', '음악 시스템', '프로젝터'],
      '조명/스위치': ['스위치/조광기', '조명', '천장 조명'],
      '에너지': ['보일러', '스마트 플러그', '에너지 모니터링'],
      '센서/보안': ['경보기', '공기질 센서', '누수감지센서', '다목적 센서 (문열림 센서)', '도어록', '동작감지센서', '방범창', '비전 센서', '연기 감지기', '열림/닫힘 센서', '온도/습도 센서', '재실 감지 센서', '조도 센서', '초인종', '카메라', '태그/트래커'],
      '허브/연결': ['리피터/확장기', '브릿지', '스마트 홈 어댑터(동글)', '스마트 홈 허브'],
      '웨어러블': ['Buds', '링', '워치'],
      '피트니스/헬스': ['베개', '체온계', '체중계', '피트니스 매트', '혈당측정기', '혈압계'],
      '라이프스타일/기타': ['금고', '리모컨/버튼', '무선 충전기', '반려동물 급식기', '밸브', '비데', '스프링클러', '온열매트', '자동차', '전기차 충전기', '차고 문', '창문 개폐기', '커튼/블라인드', '홈 로봇', '기타']
    };
    
    // Capability Map for Logic Engine
    const CAPABILITY_MAP = {
      '스마트 홈 허브': ['hub', 'hub_zigbee', 'hub_thread', 'hub_zwave'],
      '스마트 홈 어댑터(동글)': ['hub', 'hub_zigbee'],
      '브릿지': ['hub'],
      '스피커': ['audio_out', 'speaker', 'volume'],
      '사운드바': ['audio_out'],
      '조명': ['light'], '천장 조명': ['light'],
      '스위치/조광기': ['switch'],
      '동작감지센서': ['sensor_motion'],
      '재실 감지 센서': ['sensor_presence'],
      '다목적 센서 (문열림 센서)': ['sensor_contact'], '열림/닫힘 센서': ['sensor_contact'],
      '공기질 센서': ['sensor_air'], '온도/습도 센서': ['sensor_temp'],
      '에어컨': ['hvac'], '송풍/환기': ['ventilation'], '제습기': ['hvac'], '가습기': ['hvac'],
      '쿡탑': ['cooktop'], '레인지': ['cooktop'],
      '후드': ['hood'],
      '도어록': ['doorlock'],
      '카메라': ['camera'], '초인종': ['camera'],
      '스마트 플러그': ['smart_plug'], '에너지 모니터링': ['energy_monitor'],
      '로봇청소기': ['robot_cleaner', 'vacuum', 'clean'],
    };

    const DEVICE_ICON_MAP = {
      '건조기': 'dryer', '로봇청소기': 'robot_vacuum', '미세플라스틱 필터': 'microplastic_filter', '세탁기': 'washing_machine', '슈드레서': 'shoedresser', '스틱 청소기': 'stick_vacuum_cleaner', '에어드레서': 'airdresser',
      '가습기': 'humidifier', '공기청정기': 'air_purifier', '송풍/환기': 'vent', '에어컨': 'aircon', '제습기': 'dehumidifier',
      '냉장고': 'refrigerator', '레인지': 'range', '식기세척기': 'dishwasher', '오븐': 'oven', '전기밥솥': 'rice_cooker', '전자레인지': 'microwave', '정수기': 'water_purifier', '쿡탑': 'cooktop', '후드': 'hood',
      'AV 리시버': 'av_receiver', 'TV': 'tv', '디스플레이': 'display', '모니터': 'monitor', '사운드바': 'soundbar', '스피커': 'speaker', '음악 시스템': 'music_system', '프로젝터': 'projector',
      '스위치/조광기': 'switch_dimmer', '조명': 'lighting', '천장 조명': 'ceiling_light',
      '보일러': 'boiler', '스마트 플러그': 'smart_plug', '에너지 모니터링': 'energy_monitoring',
      '경보기': 'alarm', '공기질 센서': 'air_quality_sensor', '누수감지센서': 'leak_sensor', '다목적 센서 (문열림 센서)': 'multi_sensor', '도어록': 'doorlock', '동작감지센서': 'motion_sensor', '방범창': 'security_window', '비전 센서': 'vision_sensor', '연기 감지기': 'smoke_detector', '열림/닫힘 센서': 'open_close_sensor', '온도/습도': 'temp_hum_sensor', '온도/습도 센서': 'temp_hum_sensor', '재실 감지 센서': 'presence_sensor', '조도 센서': 'illuminance_sensor', '초인종': 'doorbell', '카메라': 'camera', '태그/트래커': 'tag_tracker',
      '리피터/확장기': 'repeater', '브릿지': 'bridge', '스마트 홈 어댑터(동글)': 'adapter', '스마트 홈 허브': 'hub',
      'Buds': 'buds', '링': 'ring', '워치': 'watch',
      '베개': 'pillow', '체온계': 'thermometer', '체중계': 'scale', '피트니스 매트': 'fitness_mat', '혈당측정기': 'glucometer', '혈압계': 'blood_pressure',
      '금고': 'safe', '리모컨/버튼': 'remote_button', '무선 충전기': 'wireless_charger', '반려동물 급식기': 'pet_feeder', '밸브': 'valve', '비데': 'bidet', '스프링클러': 'sprinkler', '온열매트': 'heating_mat', '자동차': 'car', '전기차 충전기': 'ev_charger', '차고 문': 'garage_door', '창문 개폐기': 'window_opener', '커튼/블라인드': 'curtain_blind', '홈 로봇': 'home_robot', '기타': 'other'
    };
    
    // [신규] 기기 프로필 사전 (동의어 매핑)
    const DEVICE_SYNONYM_DICTIONARY = {
      // 조명
      '무드등': '조명',
      '라이트 스트립': '조명',
      '스트립 라이트': '조명',
      '간접조명': '조명',
      '벽부등': '조명',
      '스탠드': '조명',
      '전구': '조명',
      '전등': '조명',
      '램프': '조명',
      '필립스 휴': '조명',
      '필립스 휴 화이트 앰비언스': '조명',
      '필립스 휴 그라디언트': '조명',
      '휴': '조명',
      '필립스 위즈': '조명',
      '위즈': '조명',
      '이케아 트로드프리 전구': '조명',
      '트로드프리 전구': '조명',
      '나노리프': '조명',

      // 천장 조명
      '다운라이트': '천장 조명',
      '천정등': '천장 조명',
      '생체리듬 IoT 방등': '천장 조명',
      '삼성 생체리듬 IoT 방등': '천장 조명',
      '삼성 IoT 방등': '천장 조명',

      // 스위치
      '디밍 스위치': '스위치/조광기',
      '무선 스위치': '스위치/조광기',
      '투야 스위치': '스위치/조광기',
      '시하스 스위치': '스위치/조광기',
      '한샘 스위치': '스위치/조광기',
      '아카라 H1 노브': '스위치/조광기',

      '스마트 버튼': '리모컨/버튼',
      '버튼': '리모컨/버튼',
      '모멘터리 버튼': '리모컨/버튼',
      '스마트싱스 버튼': '리모컨/버튼',
      '투야 노브': '리모컨/버튼',
      '이케아 스튀르바르': '리모컨/버튼',
      '이케아 무선디머': '리모컨/버튼',
      '이케아 로트레트': '리모컨/버튼',
      '투야 씬스위치': '리모컨/버튼',
      
      '아카라 커튼 컨트롤러 E1': '커튼/블라인드',
      '마마바 매터 전동모터': '커튼/블라인드',
      '마마바 matter 전동모터': '커튼/블라인드',

      //다목적 센서 (문열림 센서)
      '도어 센서': '다목적 센서 (문열림 센서)',
      '창문 센서': '다목적 센서 (문열림 센서)',
      '문열림 센서': '다목적 센서 (문열림 센서)',
      '스마트싱스 문열림 센서': '다목적 센서 (문열림 센서)',
      '아카라 도어센서': '다목적 센서 (문열림 센서)',
      '아카라 도어 센서 T1': '다목적 센서 (문열림 센서)',
      '투야 도어센서': '다목적 센서 (문열림 센서)',

      //온도/습도 센서
      '온습도계': '온도/습도 센서',
      '아카라 온습도센서': '온도/습도 센서',

      //재실 감지 센서
      '재실 센서': '재실 감지 센서',
      '재실센서': '재실 감지 센서',
      '카운터 센서': '재실 감지 센서',
      '카운터센서': '재실 감지 센서',
      '시하스 재실센서': '재실 감지 센서',
      '시하스 재실 카운터 센서': '재실 감지 센서',
      '시하스 재실 카운터센서': '재실 감지 센서',
      '시하스 카운터재실센서': '재실 감지 센서',
      '시하스 카운터센서': '재실 감지 센서',
      '아카라 재실센서': '재실 감지 센서',
      '아카라 재실센서 fp300': '재실 감지 센서',
      '아카라 fp300': '재실 감지 센서',
      '아카라 재실센서 fp2': '재실 감지 센서',
      '아카라 fp2': '재실 감지 센서',
      '아카라 재실센서 fp1': '재실 감지 센서',
      '아카라 fp1': '재실 감지 센서',

      //동작감지센서
      '모션 센서': '동작감지센서',
      '모션센서': '동작감지센서',
      'PIR 센서': '동작감지센서',
      'PIR센서': '동작감지센서',

      // 전원/에너지 관련 (Power/Energy)
      '스마트 콘센트': '스마트 플러그',
      '멀티탭': '스마트 플러그',
      'iot멀티탭': '스마트 플러그',
      'broadlink mp1': '스마트 플러그',
      'lellki': '스마트 플러그',
      'Useelink': '스마트 플러그',
      '다원 파워매니저 16a SmartThings': '스마트 플러그',
      '다원 지그비 플러그 16A SmartThings': '스마트 플러그',
      '이케아 트로드프리 플러그 16a': '스마트 플러그',
      '아카라 10a 플러그': '스마트 플러그',
      '싱스원 플러그 16a': '스마트 플러그',

      '에너지미터': '에너지 모니터링',
      '전력량계': '에너지 모니터링',
      '시하스 전력량계': '에너지 모니터링',
      '한전 전력량계': '에너지 모니터링',
      '한국전력 전력량계': '에너지 모니터링',
      '다원 파워매니저 에너지미터': '에너지 모니터링',
      '에너지퍼': '에너지 모니터링',

      // 카메라
      '현관 카메라': '카메라',
      'CCTV': '카메라',
      '홈 카메라': '카메라',
      '홈캠': '카메라',
      '스마트싱스용 홈카메라360': '카메라',
      '스마트싱스용 홈카메라': '카메라',
      '스마트싱스용 홈 카메라': '카메라',
      '홈카메라360': '카메라',

      '삼성 AI 도어캠': '초인종',
      
      //태그/트래커
      '스마트태그': '태그/트래커',
      '갤럭시 스마트태그1': '태그/트래커',
      '갤럭시 스마트태그': '태그/트래커',
      '갤럭시 스마트태그 플러스': '태그/트래커',
      '갤럭시 스마트태그2': '태그/트래커',
      '솔루엠 스마트태그': '태그/트래커',
      '솔루엠 스마트태그 플러스': '태그/트래커',
      '국민카드 IoT 카드': '태그/트래커',

      // 가전
      'TV': 'TV',
      '텔레비전': 'TV',
      '티비': 'TV',
      '텔레비젼': 'TV',

      '스마트 모니터': '모니터',
      '삼성 오디세이': '모니터',
      '오디세이': '모니터',
      '삼성 뷰피니티': '모니터',
      '뷰피니티': '모니터',
      '삼성 무빙스타일': '모니터',
      '삼성 무빙 스타일': '모니터',
      '무빙스타일': '모니터',
      '무빙 스타일': '모니터',

      '삼성 더 프리스타일': '프로젝터',
      '삼성 더프리스타일': '프로젝터',
      '더프리스타일': '프로젝터',
      '삼성 더 프리미어': '프로젝터',
      '삼성 더프리미어': '프로젝터',
      '더 프리미어': '프로젝터',
      '더프리미어': '프로젝터',
      
      '스마트 스피커': '스피커',
      '스마트스피커': '스피커',

      '삼성 비스포크 후드 Air': '후드',
      '비스포크 후드 Air': '후드',
      '데이코 후드': '후드',

      '삼성 비스포크 인덕션': '레인지',
      '비스포크 인덕션': '레인지',
      '데이코 인덕션': '레인지',
      '인덕션': '레인지',

      '광파오븐': '오븐',
      '큐커': '오븐',
      '큐커 오븐': '오븐',
      '큐커 멀티': '오븐',
      '비스포크 큐커': '오븐',
      '삼성 비스포크 오븐': '오븐',
      '비스포크 오븐': '오븐',
      '삼성 비스포크 큐커': '오븐',
      '비스포크 광파오븐': '오븐',

      '삼성 비스포크 정수기': '정수기',
      '비스포크 정수기': '정수기',

      '삼성 비스포크 식기세척기': '식기세척기',
      '비스포크 식기세척기': '식기세척기',

      '로봇 청소기': '로봇청소기',

      '시스템 에어컨': '에어컨',
      '벽걸이 에어컨': '에어컨',
      '비스포크 시스템에어컨 인피니트라인': '에어컨',
      '삼성 비스포크 무풍에어컨': '에어컨',
      '삼성 윈도우핏3': '에어컨',

      '삼성 인버터 제습기': '제습기',
      '삼성 인버터제습기': '제습기',
      '삼성 제습기': '제습기',

      '휴젠뜨': '송풍/환기',
      '삼성 시스템 청정환기': '송풍/환기',
      '나비엔 스마트': '송풍/환기',

      '공청기': '공기청정기',
      '삼성 비스포크 큐브 에어 인피니트라인': '공기청정기',
      '삼성 비스포크 큐브 에어': '공기청정기',
      '삼성 큐브': '공기청정기',
      '삼성 블루스카이': '공기청정기',
      '강제환기 키트': '공기청정기',
      '환기타임': '공기청정기',

      'AEON 멀티센서': '공기질 센서',
      'netatmo station': '공기질 센서',
      '삼성 에어모니터 플러스': '공기질 센서',
      '에어모니터 플러스': '공기질 센서',
      '시하스 다기능센서': '공기질 센서',

      'echobee 온도조절기': '보일러',
      '네스트 온도조절기': '보일러',
      '귀뚜라미 온도조절기': '보일러',
      '투야 액추에이터': '보일러',
      
    
      '스마트싱스 스테이션': '스마트 홈 허브',
      '스싱스': '스마트 홈 허브',
      '스테이션': '스마트 홈 허브',
      '스마트싱스 허브 V4': '스마트 홈 허브',
      '스마트싱스 V4 허브': '스마트 홈 허브',
      'V4허브': '스마트 홈 허브',
      'V4 허브': '스마트 홈 허브',
      '싱스원 스마트홈 허브': '스마트 홈 허브',
      '스마트싱스 허브 V3': '스마트 홈 허브',
      '스마트싱스 V3 허브': '스마트 홈 허브',
      'V3허브': '스마트 홈 허브',
      'V3 허브': '스마트 홈 허브'
    };

    // [신규] 프로필 매칭 헬퍼 함수
    function getProfileName(userInputName) {
      if (!userInputName) return '';
      // 1. 표준 이름이 그대로 들어온 경우
      if (CAPABILITY_MAP.hasOwnProperty(userInputName)) return userInputName;
      // 2. 사전에 등록된 동의어인 경우
      if (DEVICE_SYNONYM_DICTIONARY[userInputName]) return DEVICE_SYNONYM_DICTIONARY[userInputName];
      // 3. 매칭 실패 시 원본 반환 (아이콘은 other 처리됨)
      return userInputName;
    }
    const DEFAULT_PRESETS = [
      { 
        name: '스마트홈의 시작', 
        device: '스마트싱스 스테이션', 
        protocol: 'Zigbee', 
        qty: 1 
      },
      { 
        name: '고성능 스마트홈 짓기', 
        device: '스마트싱스 허브 V4', 
        protocol: 'Zigbee', 
        qty: 2 
      },
      { 
        name: '스마트홈에 Z-Wave 한 스푼', 
        device: '스마트싱스 허브 V3', 
        protocol: 'Z-Wave', 
        qty: 3 
      },
      { 
        name: '색 온도를 바꾸는 전구', 
        device: '필립스 휴 화이트 앰비언스', 
        protocol: 'Zigbee', 
        qty: 4 
      },
      { 
        name: '라이트스트립', 
        device: '필립스 휴 그라디언트', 
        protocol: 'Zigbee', 
        qty: 5
      },
      { 
        name: '만능 문열림 센서', 
        device: '스마트싱스 문열림 센서', 
        protocol: 'Zigbee', 
        qty: 6
      },
      { 
        name: '작은 문열림 센서', 
        device: '아카라 도어 센서 T1', 
        protocol: 'Zigbee', 
        qty: 7
      },
      { 
        name: '플러그로 일반 제품을 IoT화 하기', 
        device: '다원 지그비 플러그 16A SmartThings', 
        protocol: 'Zigbee', 
        qty: 8
      },
      { 
        name: '들어가면 자동으로 불 켜기', 
        device: '시하스 재실 카운터 센서', 
        protocol: 'Zigbee', 
        qty: 9
      },
      { 
        name: '재실 감지하기', 
        device: '아카라 FP2', 
        protocol: 'Wi-Fi', 
        qty: 10
      },
      { 
        name: '자동 커튼 (아카라)', 
        device: '아카라 커튼 컨트롤러 E1', 
        protocol: 'Zigbee', 
        qty: 11
      },
      { 
        name: '자동 커튼 (마마바)', 
        device: '마마바 매터 전동모터', 
        protocol: 'Zigbee', 
        qty: 12
      },
      { 
        name: '여름철 공기조화 에어컨', 
        device: '비스포크 무풍에어컨', 
        protocol: 'Wi-Fi', 
        qty: 13 
      },
      { 
        name: '빨간약', 
        device: '삼성 에어모니터 플러스', 
        protocol: 'Wi-Fi', 
        qty: 14 
      },
      { 
        name: '집 안의 보안 관리', 
        device: '스마트싱스용 홈카메라360', 
        protocol: 'Wi-Fi', 
        qty: 15
      },
      { 
        name: '짚 앞의 택배와 보안 관리', 
        device: '삼성 AI 도어캠', 
        protocol: 'Wi-Fi', 
        qty: 16
      }
    ];
    const PROTOCOLS = ['Zigbee', 'Z-Wave', 'Matter over Wi-Fi', 'Matter over Thread', 'Wi-Fi', 'Bluetooth', 'Thread', 'Galaxy Find Network'];

    // EXTERNAL LINKS & APPS
    // (Rendered dynamically in renderAppGrid)

    // --- ICON HELPER ---
    function getIcon(name, size = 20, className = "") {
      const paths = {
        Menu: '<line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/>',
        Camera: '<path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/>',
        MoreHorizontal: '<circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/>',
        Plus: '<path d="M5 12h14"/><path d="M12 5v14"/>',
        Settings: '<path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/>',
        HelpCircle: '<circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/>',
        Smartphone: '<rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/>',
        Trash2: '<path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/>',
        Copy: '<rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>',
        ArrowUp: '<path d="m5 12 7-7 7 7"/><path d="M12 19V5"/>',
        ArrowDown: '<path d="M12 5v14"/><path d="m19 12-7 7-7-7"/>',
        LogOut: '<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/>',
        RotateCcw: '<path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 5v7h7"/>',
        Moon: '<path d="M12 3a6 6 0 0 0 9 9 9 0 1 1-9-9Z"/>',
        Box: '<path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" x2="12" y1="22.08" y2="12"/>',
        Check: '<polyline points="20 6 9 17 4 12"/>',
        X: '<path d="M18 6 6 18"/><path d="m6 6 12 12"/>',
        ArrowLeft: '<path d="m12 19-7-7 7-7"/><path d="M19 12H5"/>',
        AlertTriangle: '<path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/>',
        Info: '<circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/>',
        Bell: '<path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/>',
        Play: '<polygon points="5 3 19 12 5 21 5 3"/>',
        Grid: '<rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>',
        ExternalLink: '<path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/>',
        Share: '<path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" x2="12" y1="2" y2="15"/>',
        Book: '<path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>',
        Zap: '<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>',
        Sun: '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>',
        Sunrise: '<path d="M12 2v8"/><path d="m4.93 10.93 1.41 1.41"/><path d="M2 18h2"/><path d="M20 18h2"/><path d="m19.07 10.93-1.41 1.41"/><path d="M22 22H2"/><path d="m8 6 4-4 4 4"/><path d="M16 18a4 4 0 0 0-8 0"/>',
        Music: '<path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/>',
        Monitor: '<rect width="20" height="14" x="2" y="3" rx="2"/><line x1="8" x2="16" y1="21" y2="21"/><line x1="12" x2="12" y1="17" y2="21"/>',
        Columns: '<path d="M12 3h7a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-7m0-18H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h7m0-18v18"/>',
        Wind: '<path d="M17.7 7.7a2.5 2.5 0 1 1 1.8 4.3H2"/><path d="M9.6 4.6A2 2 0 1 1 11 8H2"/><path d="M12.6 19.4A2 2 0 1 0 14 16H2"/>',
        Fan: '<path d="M10.827 16.379a6.082 6.082 0 0 1-8.618-7.002l5.412 1.45a6.082 6.082 0 0 1 7.002-8.618l-1.45 5.412a6.082 6.082 0 0 1 8.618 7.002l-5.412-1.45a6.082 6.082 0 0 1-7.002 8.618l1.45-5.412Z"/>',
        Door: '<path d="M4 22h14a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2Z"/><path d="M16 12h.01"/>',
        Flame: '<path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.5-3.3.3-1.12.5-1.68 1-2.5 0 0 1.5-1 2-2.5 0 2.5.5 5.5 1.5 8.25Z"/>',
        Home: '<path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>',
        Car: '<path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/><path d="M5 17h2"/><path d="M15 17h2"/>',
        Globe: '<circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>'
      };
      return `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}">${paths[name] || ''}</svg>`;
    }

    // --- AUTOMATION RULES & ENGINE ---
    const AUTOMATION_RULES = [
      {
        id: 'auto_light', name: '자동불 자동화', icon: 'Sun',
        desc: '동작감지센서나 재실센서를 통해 사람이 감지되면 자동으로 조명을 켭니다.',
        check: (devs) => {
          const sensors = devs.filter(d => ['sensor_motion', 'sensor_presence'].some(c => d.caps.includes(c)));
          const lights = devs.filter(d => d.caps.includes('light'));
          return (sensors.length > 0 && lights.length > 0) ? [...sensors, ...lights] : null;
        }
      },
      {
        id: 'wakeup_light', name: '기상불 자동화', icon: 'Sunrise',
        desc: '아침 기상 시간에 맞춰 조명이 서서히 밝아지며 자연스러운 기상을 돕습니다.',
        check: (devs) => {
          const lights = devs.filter(d => d.caps.includes('light'));
          return lights.length > 0 ? lights : null;
        }
      },
      // 기상나팔 자동화
      {
          id: 'wakeup_horn',
          name: '기상나팔 자동화',
          desc: '설정된 시간에 스피커에서 지정된 소리를 재생하여 알람 역할을 합니다.',
          icon: 'Volume2',
          check: (devs) => {
              // speaker capability를 가진 기기를 찾습니다.
              const speakers = devs.filter(d => d.caps.includes('speaker'));
              return speakers.length > 0 ? speakers : null;
          }
      },
      //엄크 자동화 (엄마 크리티컬)
      {
          id: 'mom_emergency',
          name: '엄크 자동화',
          desc: '외부 움직임을 감지하면 지정된 기기(TV, PC 등)의 전원을 즉시 차단합니다.',
          icon: 'ShieldOff',
          check: (devs) => {
              // 동작 감지 센서 (sensor)와 전원 차단 기기 (switch/power)가 필요합니다.
              const sensors = devs.filter(d => d.caps.includes('sensor'));
              const switches = devs.filter(d => d.caps.includes('switch') && d.caps.includes('power'));

              if (sensors.length > 0 && switches.length > 0) {
                  return [...new Set([...sensors, ...switches])];
              }
              return null;
          }
      },
      // 인공지능 청정
      {
          id: 'ai_purifying',
          name: '인공지능 청정',
          desc: '실내 미세먼지 수치를 파악하여 공기청정기가 자동으로 작동 모드를 조절합니다.',
          icon: 'AirVent',
          check: (devs) => {
              // 공기청정기 (air_purifier)와 공기질 센서 (sensor_air)가 필요합니다.
              const purifiers = devs.filter(d => d.caps.includes('air_purifier'));
              const airSensors = devs.filter(d => d.device === '공기질 센서'); // 프로필 이름으로 직접 비교

              if (purifiers.length > 0 && airSensors.length > 0) {
                   return [...new Set([...purifiers, ...airSensors])];
              }
              return null;
          }
      },
      // 후드 자동화
      {
          id: 'range_hood',
          name: '후드 자동화',
          desc: '가스 감지 센서 또는 요리 시작 시점 감지 센서에 따라 주방 후드를 자동으로 켜고 끕니다.',
          icon: 'Fan',
          check: (devs) => {
              // 후드(switch/fan)와 요리 감지 센서(cooktop) 또는 동작 센서(sensor)가 필요합니다.
              const hoods = devs.filter(d => d.caps.includes('fan') && d.device === '후드');
              const sensors = devs.filter(d => d.caps.includes('sensor'));

              if (hoods.length > 0 && sensors.length > 0) {
                  return [...new Set([...hoods, ...sensors])];
              }
              return null;
          }
      },
      // 센서등 자동화
      {
          id: 'sensor_light',
          name: '센서등 자동화',
          desc: '움직임이 감지될 때만 조명을 켜고, 일정 시간 후 자동으로 끕니다.',
          icon: 'Zap',
          check: (devs) => {
              // 동작 감지 센서 (sensor)와 조명 (light)이 모두 필요합니다.
              const sensors = devs.filter(d => d.caps.includes('sensor'));
              const lights = devs.filter(d => d.caps.includes('light'));

              if (sensors.length > 0 && lights.length > 0) {
                   return [...new Set([...sensors, ...lights])];
              }
              return null;
          }
      },
      // 청소 자동화
      {
          id: 'cleaning_bot',
          name: '청소 자동화',
          desc: '사용자가 외출하거나 마지막 사람이 집을 나설 때 로봇 청소기가 청소를 시작합니다.',
          icon: 'brush',
          check: (devs) => {
              // 로봇청소기 (vacuum) capability를 가진 기기를 찾습니다.
              const vacuums = devs.filter(d => d.caps.includes('vacuum'));
              return vacuums.length > 0 ? vacuums : null;
          }
      },
      
      {
        id: 'sleep_light', name: '수면등 자동화', icon: 'Moon',
        desc: '취침 시간에 맞춰 수면에 방해되지 않는 은은한 조명으로 자동 전환합니다.',
        check: (devs) => {
           const lights = devs.filter(d => d.caps.includes('light'));
           return lights.length > 0 ? lights : null;
        }
      },
      {
        id: 'bulk_off', name: '일괄소등 자동화', icon: 'LogOut',
        desc: '외출 시 버튼 하나로 집안의 모든 조명을 한 번에 끕니다.',
        check: (devs) => {
           const switches = devs.filter(d => d.caps.includes('switch'));
           const lights = devs.filter(d => d.caps.includes('light'));
           return (switches.length > 0 && lights.length > 1) ? [...switches, ...lights] : null;
        }
      },
      {
        id: 'circadian', name: '하루조명', icon: 'Sun',
        desc: '시간대에 따라 태양광과 유사한 색온도로 조명이 자동 조절됩니다.',
        check: (devs) => {
           const lights = devs.filter(d => d.caps.includes('light'));
           return lights.length > 0 ? lights : null;
        }
      },
      {
        id: 'music_sync', name: '뮤직싱크', icon: 'Music',
        desc: '음악 비트에 맞춰 조명 색상이 변하여 파티 분위기를 연출합니다.',
        check: (devs) => {
           const speakers = devs.filter(d => d.caps.includes('audio_out'));
           const lights = devs.filter(d => d.caps.includes('light'));
           return (speakers.length > 0 && lights.length > 0) ? [...speakers, ...lights] : null;
        }
      },
      {
        id: 'pc_auto', name: 'PC 자동화', icon: 'Monitor',
        desc: 'PC 전원이 켜지면 주변 조명을 게이밍 모드로 전환하거나 스피커를 켭니다.',
        check: (devs) => {
           const plugs = devs.filter(d => d.caps.includes('smart_plug'));
           return plugs.length > 0 ? plugs : null;
        }
      },
      {
        id: 'curtain_auto', name: '커튼/블라인드 자동화', icon: 'Columns',
        desc: '일출/일몰 시간이나 기상 시간에 맞춰 커튼을 자동으로 여닫습니다.',
        check: (devs) => {
           const curtains = devs.filter(d => d.device.includes('커튼') || d.device.includes('블라인드'));
           return curtains.length > 0 ? curtains : null;
        }
      },
      {
        id: 'cooling_auto', name: '냉방 자동화', icon: 'Wind',
        desc: '실내 온도가 설정값보다 높아지면 에어컨을 자동으로 가동합니다.',
        check: (devs) => {
           const hvac = devs.filter(d => d.caps.includes('hvac'));
           const sensors = devs.filter(d => d.caps.includes('sensor_temp'));
           return (hvac.length > 0 && sensors.length > 0) ? [...hvac, ...sensors] : null;
        }
      },
      {
        id: 'vent_auto', name: '환기 자동화', icon: 'Fan',
        desc: '공기질이 나빠지면 환기 시스템을 가동하거나 창문을 엽니다.',
        check: (devs) => {
           const vents = devs.filter(d => d.caps.includes('ventilation') || d.device.includes('창문'));
           const sensors = devs.filter(d => d.caps.includes('sensor_air'));
           return (vents.length > 0 && sensors.length > 0) ? [...vents, ...sensors] : null;
        }
      },
      {
        id: 'air_care', name: '공기조화 자동화', icon: 'Fan',
        desc: '창문이 닫혀있을 때만 공기청정기나 에어컨을 가동하여 효율을 높입니다.',
        check: (devs) => {
           const doors = devs.filter(d => d.caps.includes('sensor_contact'));
           const hvac = devs.filter(d => d.caps.includes('hvac') || d.device.includes('공기청정기'));
           return (doors.length > 0 && hvac.length > 0) ? [...doors, ...hvac] : null;
        }
      },
      {
        id: 'sleep_mode', name: '취침 자동화', icon: 'Moon',
        desc: '취침 모드 실행 시 가전제품을 조용하게 만들고 불필요한 전원을 차단합니다.',
        check: (devs) => {
           const relevant = devs.filter(d => d.caps.includes('switch') || d.caps.includes('light'));
           return relevant.length > 0 ? relevant : null;
        }
      },
      {
        id: 'power_restore', name: '정전보상 자동화', icon: 'Zap',
        desc: '정전 후 전기가 복구될 때 조명이 갑자기 켜지지 않도록 이전 상태를 유지합니다.',
        check: (devs) => {
           const lights = devs.filter(d => d.caps.includes('light'));
           return lights.length > 0 ? lights : null;
        }
      },
      {
        id: 'fire_safety', name: '소방 대비 자동화', icon: 'AlertTriangle',
        desc: '화재 감지 시 모든 조명을 켜고 대피 경로를 확보하며 알림을 보냅니다.',
        check: (devs) => {
           const smoke = devs.filter(d => d.device.includes('연기') || d.device.includes('화재'));
           return smoke.length > 0 ? smoke : null;
        }
      },
      {
        id: 'ai_energy', name: 'AI 절약모드', icon: 'Zap',
        desc: 'AI가 사용 패턴을 분석하여 가전제품의 에너지 사용량을 최적화합니다.',
        check: (devs) => {
           const targets = ['에어컨', '냉장고', '세탁기', '건조기', '에어드레서'];
           const appliances = devs.filter(d => targets.some(t => d.device.includes(t)));
           return appliances.length > 0 ? appliances : null;
        }
      },
      {
        id: 'energy_save', name: '전기 절약 자동화', icon: 'Zap',
        desc: '사용하지 않는 시간대에 대기전력을 차단하여 전기요금을 절약합니다.',
        check: (devs) => {
           const plugs = devs.filter(d => d.caps.includes('smart_plug') || d.caps.includes('energy_monitor'));
           return plugs.length > 0 ? plugs : null;
        }
      },
      {
        id: 'phone_noti', name: '스마트폰 알림 자동화', icon: 'Smartphone',
        desc: '집안의 상태(문 열림, 누수 등)의 바뀜을 스마트폰으로 즉시 알려줍니다.',
        check: (devs) => {
           const sensors = devs.filter(d => d.caps.some(c => c.startsWith('sensor')));
           return sensors.length > 0 ? sensors : null;
        }
      },
      {
        id: 'middle_door', name: '중문 자동화', icon: 'Door',
        desc: '현관에 들어서면 중문이 자동으로 열려 짐이 있어도 편하게 들어갑니다.',
        check: (devs) => {
           const motion = devs.filter(d => d.caps.includes('sensor_motion'));
           // Assuming a motor/opener is needed, but motion implies capability to trigger if installed
           return motion.length > 0 ? motion : null;
        }
      },
      {
        id: 'ac_dry', name: '에어컨 송풍', icon: 'Wind',
        desc: '에어컨 끄기 전 자동 건조 기능을 활성화하여 곰팡이를 방지합니다.',
        check: (devs) => {
           const ac = devs.filter(d => d.device.includes('에어컨'));
           return ac.length > 0 ? ac : null;
        }
      },
      {
        id: 'heating', name: '난방 자동화', icon: 'Sun',
        desc: '외출 시 난방을 줄이고 귀가 전에 미리 따뜻하게 데워둡니다.',
        check: (devs) => {
           const heat = devs.filter(d => d.device.includes('보일러') || d.device.includes('온열'));
           return heat.length > 0 ? heat : null;
        }
      },
      {
        id: 'window_auto', name: '자바라 자동화', icon: 'Columns',
        desc: '창문 개폐기를 통해 환기하거나 비가 올 때 자동으로 창문을 닫습니다.',
        check: (devs) => {
           const wins = devs.filter(d => d.device.includes('창문') || d.device.includes('개폐기'));
           return wins.length > 0 ? wins : null;
        }
      }
    ];

    // --- PROGRESSIVE AUTOMATION SCORE ENGINE ---
    const AutomationAnalyzer = (() => {
      // Helper to check capability based on Profile Name
      const hasCap = (dev, cap) => (CAPABILITY_MAP[getProfileName(dev)] || []).includes(cap);
      
      // [수정] 기기 리스트 생성 시 getProfileName 적용하여 capability 매핑
      const getDeviceList = (rooms) => rooms.flatMap((r, ri) => r.rows.map(row => ({ 
          ...row, 
          rIdx: ri, 
          caps: CAPABILITY_MAP[getProfileName(row.device)] || [] 
      })));

      function analyze(rooms) {
        let reasons = [];
        const devices = getDeviceList(rooms);
        
        const hubTypes = new Set();
        devices.forEach(d => {
          if (d.caps.includes('hub_zigbee')) hubTypes.add('Zigbee');
          if (d.caps.includes('hub_thread')) hubTypes.add('Thread');
          if (d.caps.includes('hub_zwave')) hubTypes.add('Z-Wave');
          if (d.protocol && (d.protocol.toLowerCase().includes('wi-fi') || d.protocol.toLowerCase().includes('matter'))) hubTypes.add('Wi-Fi');
        });

        const zigbeeDevs = devices.filter(d => d.protocol && d.protocol.toLowerCase().includes('zigbee'));
        const zwaveDevs = devices.filter(d => d.protocol && d.protocol.toLowerCase().includes('z-wave'));
        const threadDevs = devices.filter(d => d.protocol && d.protocol.toLowerCase().includes('thread'));
        
        let baseScore = 20;
        if (hubTypes.size >= 1) baseScore = 50;
        if (hubTypes.size >= 2) baseScore = 60;

        if (zigbeeDevs.length > 0 && !hubTypes.has('Zigbee')) {
          reasons.push({ code: 'ZIGBEE_NO_HUB', severity: 'critical', impact: -50, message: 'Zigbee 기기가 있지만 허브가 없습니다.', related: zigbeeDevs });
        }
        // ... (나머지 로직 동일, hasCap 함수가 위에서 수정되었으므로 아래 로직들은 자동 적용됨)
        if (zwaveDevs.length > 0 && !hubTypes.has('Z-Wave')) {
          reasons.push({ code: 'ZWAVE_NO_HUB', severity: 'critical', impact: -50, message: 'Z-Wave 기기가 있지만 허브가 없습니다.', related: zwaveDevs });
        }
        if (threadDevs.length > 0 && !hubTypes.has('Thread')) {
          reasons.push({ code: 'THREAD_NO_HUB', severity: 'critical', impact: -45, message: 'Thread 기기를 위한 허브가 필요합니다.', related: threadDevs });
        }
        
        const isolated = devices.filter(d => d.caps.length === 0).length;
        if (devices.length > 5 && (isolated / devices.length) > 0.6) {
           reasons.push({ code: 'ISOLATED_DEVICES', severity: 'major', impact: -12, message: '연동 불가능한 독립 기기 비율이 높습니다.', related: [] });
        }
        
        let emptyCount = 0;
        rooms.forEach(r => { if (r.rows.length === 0) emptyCount++; });
        if (rooms.length > 0 && emptyCount === rooms.length) {
           reasons.push({ code: 'ALL_ROOMS_EMPTY', severity: 'critical', impact: -40, message: '모든 방이 비어있습니다. 기기를 추가하세요.', related: [] });
        } else if (emptyCount > 0) {
           rooms.forEach(r => {
             if (r.rows.length === 0) {
               reasons.push({ code: 'ROOM_EMPTY', severity: 'minor', impact: -3, message: `'${r.name}' 방이 비어있습니다.`, related: [] });
             }
           });
        }

        if (hubTypes.has('Zigbee')) reasons.push({ code: 'HUB_PRESENT_ZIGBEE', severity: 'major', impact: 20, message: 'Zigbee 허브 보유', related: [] });
        if (hubTypes.has('Thread')) reasons.push({ code: 'HUB_PRESENT_THREAD', severity: 'major', impact: 20, message: 'Thread 허브 보유', related: [] });
        if (hubTypes.has('Z-Wave')) reasons.push({ code: 'HUB_PRESENT_ZWAVE', severity: 'major', impact: 20, message: 'Z-Wave 허브 보유', related: [] });

        const hubRooms = new Set();
        rooms.forEach((r, i) => {
           if(r.rows.some(d => CAPABILITY_MAP[getProfileName(d.device)]?.some(c => c.startsWith('hub')))) hubRooms.add(i);
        });
        if(hubRooms.size > 0) reasons.push({ code: 'HUB_IN_SAME_ROOM', severity: 'minor', impact: 6, message: '허브가 기기와 같은 공간에 배치됨', related: [] });

        if (hubTypes.size >= 2) {
            reasons.push({ code: 'MULTI_HUB_NETWORK', severity: 'major', impact: 10, message: '멀티 허브 네트워크 구성', related: [] });
        }

        // Room Analysis using hasCap (which now uses getProfileName)
        const roomDevs = rooms.map((r, i) => ({ 
            idx: i, 
            name: r.name,
            light: r.rows.filter(d => hasCap(d.device, 'light')),
            sensor_motion: r.rows.filter(d => hasCap(d.device, 'sensor_motion') || hasCap(d.device, 'sensor_presence') || hasCap(d.device, 'switch')),
            airq: r.rows.filter(d => hasCap(d.device, 'sensor_air')),
            hvac: r.rows.filter(d => hasCap(d.device, 'hvac') || hasCap(d.device, 'ventilation')),
            cook: r.rows.filter(d => hasCap(d.device, 'cooktop')),
            hood: r.rows.filter(d => hasCap(d.device, 'hood')),
            sec_dev: r.rows.filter(d => hasCap(d.device, 'doorlock') || hasCap(d.device, 'camera')),
            sec_sens: r.rows.filter(d => hasCap(d.device, 'sensor_contact') || hasCap(d.device, 'sensor_motion')),
            energy: r.rows.filter(d => hasCap(d.device, 'energy_monitor') || hasCap(d.device, 'smart_plug'))
        }));

        let autoCount = 0;
        let coverageSet = new Set(); 
        
        roomDevs.forEach(rd => {
            if (rd.light.length > 0 && rd.sensor_motion.length > 0) {
                 autoCount++; coverageSet.add('light');
                 reasons.push({ code: 'AUTO_LIGHT', severity: 'info', impact: 0, message: `${rd.name}: 조명 자동화 가능`, related: [] });
            } else if (rd.light.length > 0) {
                 reasons.push({ code: 'MISS_AUTO_LIGHT', severity: 'minor', impact: -6, message: `${rd.name}: 조명 자동화 센서 부족`, related: [] });
            }

            if (rd.airq.length > 0 && rd.hvac.length > 0) {
                 autoCount++; coverageSet.add('air');
                 reasons.push({ code: 'AUTO_AIR', severity: 'info', impact: 0, message: `${rd.name}: 공기질 자동화 가능`, related: [] });
            } else if (rd.airq.length > 0) {
                 reasons.push({ code: 'MISS_AUTO_AIR', severity: 'minor', impact: -8, message: `${rd.name}: 공기질 센서 활용 기기 부족`, related: [] });
            }

            if (rd.cook.length > 0 && rd.hood.length > 0) {
                 autoCount++; coverageSet.add('kitchen');
                 reasons.push({ code: 'AUTO_KITCHEN', severity: 'info', impact: 0, message: `${rd.name}: 주방 환기 자동화 가능`, related: [] });
            } else if (rd.cook.length > 0) {
                 reasons.push({ code: 'MISS_KITCHEN', severity: 'minor', impact: -6, message: `${rd.name}: 쿡탑 연동 후드 부족`, related: [] });
            }

            if (rd.sec_dev.length > 0 && rd.sec_sens.length > 0) {
                 autoCount++; coverageSet.add('sec');
                 reasons.push({ code: 'AUTO_SEC', severity: 'info', impact: 0, message: `${rd.name}: 보안 자동화 가능`, related: [] });
            } else if (rd.sec_dev.length > 0) {
                 reasons.push({ code: 'MISS_SEC', severity: 'major', impact: -10, message: `${rd.name}: 보안 기기 연동 센서 부족`, related: [] });
            }
            
            if (rd.energy.length > 0 && rd.sensor_motion.length > 0) {
                 autoCount++; 
                 reasons.push({ code: 'AUTO_ENERGY', severity: 'info', impact: 0, message: `${rd.name}: 에너지 절약 자동화 가능`, related: [] });
            }
        });

        if (autoCount >= 1) {
            reasons.push({ code: 'AUTOMATION_SINGLE', severity: 'info', impact: 18, message: '자동화 규칙 발견 (양호 도달)', related: [] });
        }
        
        if (autoCount > 1) {
            const extra = autoCount - 1;
            reasons.push({ code: 'AUTOMATION_EXTRA', severity: 'info', impact: 22 * extra, message: `추가 자동화 ${extra}건 발견`, related: [] });
        }

        if (coverageSet.size >= 3) {
            reasons.push({ code: 'COVERAGE_BONUS', severity: 'major', impact: 10, message: '핵심 3개 이상 영역 커버', related: [] });
        }

        if (devices.length > 0 && devices.every(d => !d.protocol || d.protocol.includes('Wi-Fi')) && zigbeeDevs.length === 0 && zwaveDevs.length === 0 && threadDevs.length === 0) {
           reasons.push({ code: 'WIFI_ONLY_OK', severity: 'info', impact: 4, message: 'Wi-Fi 전용 구성', related: [] });
        }
        
        const sensorCount = devices.filter(d => d.caps.some(c=>c.startsWith('sensor'))).length;
        if (sensorCount >= 3) {
             reasons.push({ code: 'ROBUSTNESS_BONUS', severity: 'minor', impact: 6, message: '센서 중복성/신뢰성 확보', related: [] });
        }

        return { reasons, baseScore, devices };
      }

      function computeScore(analysis) {
        let score = analysis.baseScore;
        analysis.reasons.forEach(r => score += r.impact);
        return Math.round(score);
      }

      return { analyze, computeScore };
    })();
    
    function renderWidgets() {
      const counts = {};
      state.rooms.forEach(r => r.rows.forEach(row => {
        if(!row.device) return;
        counts[row.device] = (counts[row.device] || 0) + (row.qty || 1);
      }));
      const keys = Object.keys(counts);
      const container = document.getElementById('widgets-area');
      if (keys.length === 0) {
        container.innerHTML = `<div class="text-slate-400 text-sm py-4 col-span-full">기기가 없습니다.</div>`;
        return;
      }

      container.innerHTML = keys.map(key => {
        // [수정] 사용자가 입력한 이름(key)에 대해 매칭되는 프로필 이름을 찾음
        const profileName = getProfileName(key);
        // [수정] 매칭된 이름으로 아이콘을 찾음
        const filename = DEVICE_ICON_MAP[profileName] || 'other';
        
        const imgSrc = `images/icons/deviceprofiles/${filename}.png`;
        const webpSrc = `images/icons/deviceprofiles/${filename}.webp`;

        return `
          <div class="flex items-center gap-3 pl-2 pr-3 h-16 rounded-full bg-white/70 dark:bg-slate-800/70 backdrop-blur-sm border border-slate-100 dark:border-slate-700 shadow-sm min-w-0">
            <div class="w-12 h-12 rounded-full bg-blue-50 dark:bg-slate-700 border border-blue-100 dark:border-slate-600 flex items-center justify-center shrink-0 text-brand overflow-hidden p-1 text-lg">
              <img src="${imgSrc}" onerror="this.src='${webpSrc}';this.onerror=()=>{this.parentElement.innerText='🔘'}" class="w-full h-full object-contain">
            </div>

            <div class="flex-1 overflow-hidden min-w-0">
              <div class="marquee">
                <div class="marquee__inner">
                  <span class="marquee-text inline-block text-sm font-bold text-slate-700 dark:text-slate-200">${escapeHtml(key)}</span>
                  <span class="marquee-text inline-block text-sm font-bold text-slate-700 dark:text-slate-200" aria-hidden="true">${escapeHtml(key)}</span>
                </div>
              </div>
            </div>

            <div class="font-bold text-brand-dark dark:text-brand-light text-sm pr-2 shrink-0">${counts[key]}</div>
          </div>
        `;
      }).join('');
      
      initMarquees();
    }
    // --- MAP VIEW RENDERER ---
    function renderMapView() {
      const container = document.getElementById('map-view-area');
      if(!container) return;
      
      const rooms = state.rooms;
      if(rooms.length === 0) { container.innerHTML = ''; return; }

      const bubbles = rooms.map((r, i) => {
         const qty = r.rows.reduce((acc, row) => acc + (row.qty || 1), 0);
         let sizeClass = 'w-20 h-20'; 
         if (qty >= 7) sizeClass = 'w-40 h-40';
         else if (qty >= 4) sizeClass = 'w-32 h-32';
         
         const opacityClass = qty === 0 ? 'opacity-40 grayscale border-dashed border-2' : 'shadow-lg border border-white/20';
         const bgClass = qty === 0 ? 'bg-slate-100 dark:bg-slate-800' : 'bg-gradient-to-br from-white/80 to-blue-50/80 dark:from-slate-800/80 dark:to-slate-900/80 backdrop-blur-md';

         const deviceList = r.rows.map(row => `${row.device} (${row.qty})`).join(', ') || '기기 없음';

         return `
           <div class="relative group cursor-pointer transition-all duration-300 hover:scale-105 hover:z-10" onclick="scrollToRoom(${i})" data-tooltip-target="true">
              <div class="${sizeClass} ${bgClass} ${opacityClass} rounded-2xl flex flex-col items-center justify-center p-2 text-center relative overflow-hidden transition-all group-hover:shadow-brand/20 group-hover:border-brand/50">
                  <div class="text-sm font-black text-slate-800 dark:text-slate-100 truncate w-full px-1">${r.name}</div>
                  <div class="mt-1 text-xs font-bold ${qty > 0 ? 'text-brand' : 'text-slate-400'} bg-white/50 dark:bg-black/20 px-2 py-0.5 rounded-full">${qty}개</div>
              </div>
              
              <div class="tooltip-box absolute top-full left-1/2 -translate-x-1/2 mt-2 w-48 bg-slate-900 text-white text-xs rounded-xl p-3 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-20 shadow-xl">
                 <div class="font-bold mb-1 border-b border-white/10 pb-1">${r.name}</div>
                 <div class="leading-relaxed text-slate-300">${deviceList}</div>
                 <div class="tooltip-arrow absolute top-[-6px] left-1/2 -translate-x-1/2 w-3 h-3 bg-slate-900 rotate-45"></div>
              </div>
           </div>
         `;
      }).join('');

      container.innerHTML = `
        <div class="flex flex-wrap items-center justify-center gap-0.5 p-6 bg-slate-50/50 dark:bg-slate-900/30 rounded-[2.5rem] border border-slate-100 dark:border-slate-800/50 mb-8 select-none">
           ${bubbles}
        </div>
      `;
    }

    function renderAutomationWidgets() {
      const container = document.getElementById('automation-widgets-area');
      if(!container) return;

      // [핵심 수정] 기기 리스트를 만들 때 getProfileName을 거쳐서 Capability를 가져옵니다.
      const devices = state.rooms.flatMap((r, ri) => r.rows.map(row => {
          // 1. 사용자 입력 이름에 대한 표준 프로필 이름 찾기 (예: 무드등 -> 조명)
          const profileName = getProfileName(row.device);
          
          return { 
              ...row, 
              rIdx: ri, 
              // 2. 표준 이름으로 Capability 조회 (그래야 '조명' 관련 자동화가 활성화됨)
              caps: CAPABILITY_MAP[profileName] || [],
              
              // 3. (옵션) 텍스트 기반 규칙(예: '커튼' 포함 여부 확인)을 위해
              // 표준 이름도 함께 검색될 수 있도록 보조 속성 추가 가능
              // 단, 현재 구조상 caps만 잘 매핑되어도 대부분 해결됩니다.
              _standardName: profileName
          };
      }));

      // 체크 로직 수행
      const validAutomations = AUTOMATION_RULES.filter(rule => rule.check(devices) !== null);

      if (validAutomations.length === 0) {
        container.innerHTML = '';
        return;
      }

      container.innerHTML = `
        <div class="backdrop-blur-md p-3 md:p-6">
           <div class="flex flex-wrap gap-y-6 justify-start">
             ${validAutomations.map(auto => {
               // 여기서도 devices 배열(위에서 caps가 수정된 버전)을 사용해 관련 기기 추출
               const related = auto.check(devices) || [];
               // Tooltip에는 사용자가 입력한 원래 이름(row.device)이 표시됨
               const relatedNames = [...new Set(related.map(r => r.device))].join(', ');
               
               return `
                 <div class="w-1/4 md:w-[12.5%] lg:w-[10%] flex flex-col items-center gap-2 group cursor-pointer relative" onclick="showAutoDetail('${auto.id}')" data-tooltip-target="true">
                    <div class="w-14 h-14 rounded-full bg-gradient-to-br from-blue-50 to-white dark:from-slate-800 dark:to-slate-700 shadow-md border border-slate-100 dark:border-slate-600 flex items-center justify-center text-brand group-hover:scale-110 group-hover:shadow-brand/20 group-hover:border-brand/50 transition-all">
                       ${getIcon(auto.icon, 24)}
                    </div>
                    <span class="text-[10px] md:text-xs font-bold text-slate-600 dark:text-slate-300 text-center leading-tight max-w-[80px] break-keep">${auto.name}</span>
                    
                    <div class="tooltip-box absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-48 bg-slate-900 text-white text-xs rounded-xl p-3 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-20 shadow-xl">
                       <div class="font-bold mb-1 text-brand-light">${auto.name}</div>
                       <div class="leading-relaxed text-slate-300">Triggered by:<br>${relatedNames}</div>
                       <div class="tooltip-arrow absolute bottom-[-6px] left-1/2 -translate-x-1/2 w-3 h-3 bg-slate-900 rotate-45"></div>
                    </div>
                 </div>
               `;
             }).join('')}
           </div>
        </div>
      `;
    }
    
    // --- SMART TOOLTIP POSITIONING ---
    function setupTooltipPositioning() {
      // Logic: On hover/touch, calculate if tooltip overflows screen edge.
      // If so, shift the tooltip box opposite way, and shift the arrow back to keep pointing at anchor.
      const handleTooltipPos = (e) => {
        const target = e.target.closest('[data-tooltip-target="true"]');
        if (!target) return;
        
        const tooltipBox = target.querySelector('.tooltip-box');
        const tooltipArrow = target.querySelector('.tooltip-arrow');
        if (!tooltipBox || !tooltipArrow) return;

        // Reset first
        tooltipBox.style.transform = 'translateX(-50%)';
        tooltipArrow.style.transform = 'translateX(-50%) rotate(45deg)';
        
        const rect = target.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const screenWidth = window.innerWidth;
        const tooltipWidth = 192; // w-48 is 12rem = 192px
        const halfWidth = tooltipWidth / 2;
        const padding = 16; // Safety margin from screen edge

        let shiftX = 0;

        // Check Left Overflow
        if (centerX - halfWidth < padding) {
          shiftX = padding - (centerX - halfWidth);
        } 
        // Check Right Overflow
        else if (centerX + halfWidth > screenWidth - padding) {
          shiftX = (screenWidth - padding) - (centerX + halfWidth);
        }

        if (shiftX !== 0) {
           // Shift box
           tooltipBox.style.transform = `translateX(calc(-50% + ${shiftX}px))`;
           // Shift arrow opposite to stay anchored
           tooltipArrow.style.transform = `translateX(calc(-50% - ${shiftX}px)) rotate(45deg)`;
        }
      };

      document.body.addEventListener('mouseover', handleTooltipPos);
      document.body.addEventListener('touchstart', handleTooltipPos, {passive: true});
    }
    
    function showAutoDetail(id) {
       const auto = AUTOMATION_RULES.find(a => a.id === id);
       if(!auto) return;
       
       // [수정됨] 상세 팝업에서도 getProfileName을 적용하여, '무드등' 입력 시 '조명'의 능력을(light) 인식하도록 수정
       const devices = state.rooms.flatMap((r, ri) => r.rows.map(row => ({ 
           ...row, 
           rIdx: ri, 
           caps: CAPABILITY_MAP[getProfileName(row.device)] || [] 
       })));
       
       const related = auto.check(devices) || [];
       const relatedNames = [...new Set(related.map(r => r.device))].join(', ');

       const html = `
         <div class="p-6 text-center">
            <div class="w-20 h-20 mx-auto rounded-full bg-blue-50 dark:bg-slate-800 flex items-center justify-center text-brand mb-4 shadow-inner">
               ${getIcon(auto.icon, 40)}
            </div>
            <h3 class="text-xl font-black text-slate-900 dark:text-white mb-2">${auto.name}</h3>
            <p class="text-slate-500 dark:text-slate-400 leading-relaxed mb-6">${auto.desc}</p>
            <div class="bg-slate-50 dark:bg-slate-800/50 rounded-xl p-4 text-left">
               <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">필요 기기 (충족됨)</div>
               <div class="text-sm font-medium text-slate-800 dark:text-slate-200">${relatedNames || '<span class="text-slate-400">없음</span>'}</div>
            </div>
         </div>
       `;
       openModal(html, '자동화 추천');
    }
    
    function scrollToRoom(idx) {
        const els = document.querySelectorAll('.room-card');
        if(els[idx]) {
           const y = els[idx].getBoundingClientRect().top + window.scrollY - 140;
           window.scrollTo({ top: y, behavior: 'smooth' });
           els[idx].classList.add('ring-4', 'ring-brand/50', 'transition-all', 'duration-500');
           setTimeout(() => els[idx].classList.remove('ring-4', 'ring-brand/50'), 1500);
        }
    }

    // --- TUTORIAL CONTROLLER ---
    const TutorialController = (() => {
      let currentStep = 0;
      const steps = [
        { title: "ShoppingThings가 처음인가요? 👋", desc: "어떤 스마트홈을 만들지 고민하지 마세요.<br>하고 싶은 기기만 고르면 추천해드릴게요.", icon: "👋" },
        { title: "방마다 기기를 선택하세요 🏠", desc: "방을 추가하고 조명, 센서, 가전 등을 골라보세요.<br>그냥 갖고 싶은 것만 체크하면 돼요.", icon: "🛋️" },
        { title: "자동화 점수 계산 💯", desc: "선택한 기기로 어떤 자동화가 가능한지 분석해줍니다.<br>점수가 높을수록 똑똑한 집이에요!", icon: "⚡" },
        { title: "결과 저장하기 💾", desc: "완성된 체크리스트는 이미지로 저장할 수 있어요.<br>갤러리에 보관하세요.", icon: "🖼️" },
        { title: "커뮤니티에 공유하기 🗣️", desc: "스마트싱스 갤러리에 내 계획을 공유하고<br>전문가들의 조언을 받아보세요!", icon: "💬" },
        { title: "이제 시작해볼까요? 🚀", desc: "ShoppingThings가 당신의 스마트홈 여정을<br>항상 응원할게요!", icon: "🎉", isLast: true }
      ];

      function render() {
        const track = document.getElementById('tuto-track');
        const dots = document.getElementById('tuto-dots');
        if(!track) return;

        track.innerHTML = steps.map((s, i) => `
          <div class="w-full shrink-0 flex flex-col items-center justify-center p-8 text-center slider-slide">
            <div class="text-6xl mb-6 animate-bounce">${s.icon}</div>
            <h3 class="text-2xl font-black text-slate-900 dark:text-white mb-4">${s.title}</h3>
            <p class="text-slate-500 dark:text-slate-400 leading-relaxed mb-8">${s.desc}</p>
            ${s.isLast ? `<button onclick="TutorialController.close(); switchView('checklist')" class="px-8 py-3 bg-brand text-white rounded-full font-bold shadow-xl hover:scale-105 transition-transform">시작하기</button>` : ''}
          </div>
        `).join('');
        
        dots.innerHTML = steps.map((_, i) => `
          <div class="w-2 h-2 rounded-full transition-all ${i === currentStep ? 'bg-brand w-6' : 'bg-slate-300 dark:bg-slate-700'}"></div>
        `).join('');
        
        updatePos();
      }

      function updatePos() {
        const track = document.getElementById('tuto-track');
        if(track) track.style.transform = `translateX(-${currentStep * 100}%)`;
        
        const dots = document.getElementById('tuto-dots');
        Array.from(dots.children).forEach((d, i) => {
           d.className = `w-2 h-2 rounded-full transition-all ${i === currentStep ? 'bg-brand w-6' : 'bg-slate-300 dark:bg-slate-700'}`;
        });

        const prevBtn = document.getElementById('tuto-prev');
        const nextBtn = document.getElementById('tuto-next');
        if(prevBtn) prevBtn.classList.toggle('hidden', currentStep === 0);
        if(nextBtn) nextBtn.innerText = currentStep === steps.length - 1 ? '완료' : '다음';
        if(nextBtn) nextBtn.style.display = currentStep === steps.length - 1 ? 'none' : 'block';
      }

      function next() {
        if (currentStep < steps.length - 1) {
          currentStep++;
          updatePos();
        } else {
          close();
          switchView('checklist');
        }
      }
      
      function prev() {
        if (currentStep > 0) {
          currentStep--;
          updatePos();
        }
      }

      function open() {
        currentStep = 0;
        const modal = document.getElementById('tutorial-modal');
        modal.classList.remove('hidden');
        render();
      }
      
      function close() {
        document.getElementById('tutorial-modal').classList.add('hidden');
      }

      return { open, close, next, prev };
    })();

    // --- UI CONTROLLER FOR SCORE & NOTIFICATIONS ---
    const ScoreUI = (() => {
      const getEl = (id) => document.getElementById(id);
      let isNotifOpen = false;
      let isExpanded = true; 
      let currentReasons = [];
      let currentScore = 0;

      function render(rooms) {
        const analysis = AutomationAnalyzer.analyze(rooms);
        currentReasons = analysis.reasons;
        currentScore = AutomationAnalyzer.computeScore(analysis);
        
        const barFill = getEl('pas-fill');
        if(!barFill) return; 

        let color, statusText;
        const clampedWidth = Math.max(0, Math.min(100, currentScore));
        
        if (currentScore >= 100) { color = '#008DF7'; statusText = '최적'; }
        else if (currentScore >= 66) { color = '#22c55e'; statusText = '양호'; }
        else if (currentScore >= 33) { color = '#F97316'; statusText = '경고'; }
        else { color = '#EF4444'; statusText = '위험'; }
        
        barFill.style.width = `${clampedWidth}%`;
        barFill.style.backgroundColor = color;
        
        const valEl = getEl('pas-val');
        if(valEl) { valEl.innerText = currentScore; valEl.style.color = color; }
        
        const statusEl = getEl('pas-status-text');
        if(statusEl) { statusEl.innerText = statusText; statusEl.style.color = color; }

        const criticals = currentReasons.filter(r => r.severity === 'critical');
        const descEl = getEl('pas-desc');
        if(descEl) {
          if (criticals.length > 0) {
            descEl.innerText = `${criticals[0].message}`;
            descEl.className = "text-xs font-bold text-red-500 text-right truncate max-w-[200px]";
          } else if (currentScore >= 100) {
            descEl.innerText = "완벽한 스마트홈입니다!";
            descEl.className = "text-xs font-bold text-brand text-right";
          } else if (currentScore >= 66) {
            descEl.innerText = "훌륭한 구성입니다.";
            descEl.className = "text-xs font-bold text-green-600 text-right";
          } else {
            descEl.innerText = "제안 항목을 확인해보세요.";
            descEl.className = "text-xs font-bold text-slate-400 text-right";
          }
        }

        renderBell();
        if(isNotifOpen) renderStack();
      }

      function renderBell() {
        const btn = getEl('btn-gnb-notif');
        if(!btn) return;
        if(!btn.innerHTML.includes('<svg')) {
           btn.innerHTML = `${getIcon('Bell', 20)}<span class="nudge-dot"></span>`;
        }
        const dot = btn.querySelector('.nudge-dot');
        if(dot) dot.style.display = currentReasons.length > 0 ? 'block' : 'none';
        
        btn.setAttribute('aria-pressed', isNotifOpen);
      }

      function toggleNotif() {
        isNotifOpen = !isNotifOpen;
        isExpanded = true;
        renderBell();
        renderStack();
      }
      
      function closeNotif() {
        if(!isNotifOpen) return;
        isNotifOpen = false;
        renderBell();
        renderStack();
      }

      function renderStack() {
        const stack = getEl('notif-stack');
        const backdrop = getEl('notif-backdrop');
        if(!stack) return;
        
        if (!isNotifOpen) {
           stack.classList.remove('open');
           backdrop.classList.remove('active');
           return;
        }

        stack.classList.add('open');
        backdrop.classList.add('active');
        
        const sorted = [...currentReasons].sort((a,b) => {
          const map = { critical: 4, major: 3, minor: 2, info: 1 };
          return map[b.severity] - map[a.severity];
        });

        if (sorted.length === 0) {
          stack.innerHTML = `<div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-100 dark:border-slate-700 shadow-xl text-center text-sm text-slate-500">알림이 없습니다.</div>`;
          return;
        }

        if (!isExpanded) {
           stack.classList.add('folded');
           const top = sorted[0];
           const count = sorted.length;
           stack.innerHTML = `
            <div class="stack-preview"></div>
            <div class="stack-preview"></div>
            <div class="stack-card p-4 flex items-center justify-between cursor-pointer hover:scale-[1.02] active:scale-95" id="stack-expand-btn">
              <div class="flex items-center gap-3 overflow-hidden">
                <div class="severity-dot ${top.severity} shrink-0"></div>
                <div class="flex flex-col overflow-hidden">
                  <span class="text-xs font-bold text-slate-800 dark:text-slate-100 truncate">${top.message}</span>
                  <span class="text-[10px] text-slate-500 truncate">${count > 1 ? `외 ${count-1}건의 항목이 있습니다.` : '탭하여 자세히 보기'}</span>
                </div>
              </div>
            </div>`;
           getEl('stack-expand-btn').onclick = () => { isExpanded = true; renderStack(); };
        } 
        else {
           stack.classList.remove('folded');
           let html = `
            <div class="stack-card p-2 flex flex-col gap-2 max-h-[70vh] flex-1">
              <div class="flex justify-between items-center px-2 pt-1 pb-1">
                <span class="text-xs font-bold text-slate-500">Analysis Result (${sorted.length})</span>
                <div class="flex gap-1">
                   <button id="stack-fold" class="p-1.5 hover:bg-slate-100 dark:hover:bg-slate-700 rounded text-slate-400" title="접기">${getIcon('ArrowDown', 14)}</button>
                   <button id="stack-close" class="p-1.5 hover:bg-slate-100 dark:hover:bg-slate-700 rounded text-slate-400" title="닫기">${getIcon('X', 14)}</button>
                </div>
              </div>
              <div class="overflow-y-auto no-scrollbar space-y-2 px-1 pb-1">
           `;
           html += sorted.map(r => `
            <div class="p-3 rounded-xl bg-slate-50 dark:bg-slate-800/50 flex gap-3 border-l-4 ${r.impact > 0 ? 'border-l-brand' : 'border-l-red-400'} animate-fadeIn">
              <div class="pt-1 shrink-0">${getSeverityIcon(r.severity, r.impact)}</div>
              <div class="flex-1 min-w-0">
                <div class="flex justify-between items-start gap-2">
                  <div class="text-xs font-bold text-slate-800 dark:text-slate-100 leading-tight">${r.message}</div>
                  <div class="text-[10px] font-black ${r.impact > 0 ? 'text-brand' : 'text-red-500'} shrink-0">
                    ${r.impact > 0 ? '+' : ''}${r.impact}
                  </div>
                </div>
                ${r.related && r.related.length ? `<div class="text-[10px] text-slate-400 mt-1 truncate">관련: ${r.related.map(d=>d.caps.includes('hub') ? '허브' : d.device).join(', ')}</div>` : ''}
              </div>
            </div>
           `).join('');
           html += `<button id="btn-show-logic" class="text-[10px] text-center w-full py-2 underline text-slate-400 hover:text-brand">점수 산출 원리 보기</button></div></div>`;
           stack.innerHTML = html;
           
           getEl('stack-fold').onclick = () => { isExpanded = false; renderStack(); };
           getEl('stack-close').onclick = closeNotif;
           getEl('btn-show-logic').onclick = ScoreUI.openLogicModal;
        }
      }

      function getSeverityIcon(s, impact) {
        if(s==='critical') return `<div class="text-red-500">${getIcon('AlertTriangle', 16)}</div>`;
        if(s==='major') return `<div class="text-orange-500">${getIcon('AlertTriangle', 16)}</div>`;
        if(impact > 0) return `<div class="text-brand">${getIcon('Check', 16)}</div>`; 
        return `<div class="text-yellow-500">${getIcon('Info', 16)}</div>`;
      }
      
      function openLogicModal() {
        const html = `
          <div class="p-6 space-y-6 text-slate-700 dark:text-slate-300 leading-relaxed text-sm">
            <p><strong>Progressive Automation Score</strong>는 스마트홈 자동화의 품질(0~100)을 수치화한 것입니다.</p>
            <div class="space-y-2">
              <h4 class="font-bold text-slate-900 dark:text-white">계산 원리 (Base: 20~60)</h4>
              <ul class="list-disc pl-5 space-y-1 text-xs">
                <li><strong>가산점 (+):</strong> 허브 보유(+20), 자동화 발견(+18), 멀티 허브(+10), 커버리지(+10) 등</li>
                <li><strong>감점 (-):</strong> 필수 허브 누락(-50, 치명적), 센서 누락(-6~10), 빈 방(-3~5) 등</li>
              </ul>
            </div>
            <div class="space-y-2">
              <h4 class="font-bold text-slate-900 dark:text-white">상태 기준</h4>
              <div class="grid grid-cols-2 gap-2 text-xs font-bold text-white text-center">
                <div class="p-2 bg-red-500 rounded">0-32 위험<br><span class="text-[10px] font-normal text-white/80">필수 허브 누락</span></div>
                <div class="p-2 bg-orange-500 rounded">33-65 경고<br><span class="text-[10px] font-normal text-white/80">센서 부족/허브 없음</span></div>
                <div class="p-2 bg-green-500 rounded">66-99 양호<br><span class="text-[10px] font-normal text-white/80">자동화 구성 완료</span></div>
                <div class="p-2 bg-[#008DF7] rounded">100+ 최적<br><span class="text-[10px] font-normal text-white/80">확장성/신뢰성 확보</span></div>
              </div>
            </div>
          </div>`;
        openModal(html, '점수 산출 원리');
      }

      return { render, toggleNotif, closeNotif, openLogicModal };
    })();

    // --- APP LOGIC ---
    const state = {
      rooms: [],
      activeRoomIdx: 0,
      sidebarMode: 'expanded',
      theme: 'light',
      visibleRowIds: new Set(),
      currentView: 'checklist' // 'checklist' | 'help'
    };

    // Storage
    const loadRooms = () => {
      try {
        const r = localStorage.getItem(STORAGE_KEY);
        let data = r ? JSON.parse(r) : createDefaultRooms();
        data.forEach(room => {
           room.rows.forEach(row => {
             if (row.isSlim === undefined) row.isSlim = false;
           });
        });
        return data;
      } catch (e) { return createDefaultRooms(); }
    };
    const createDefaultRooms = () => [{ name: '거실', rows: [{ __rid: Math.random().toString(36).slice(2), device: '스마트 스피커', protocol: 'Wi-Fi', qty: 1, isSlim: false }] }];
    const saveRooms = () => {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state.rooms));
      ScoreUI.render(state.rooms);
      renderMapView();
      renderAutomationWidgets();
    };
    const loadTheme = () => localStorage.getItem('shoppingthings:theme') || 'light';
    const saveTheme = (t) => localStorage.setItem('shoppingthings:theme', t);

    // Main Init
    function init() {
      state.rooms = loadRooms();
      state.theme = loadTheme();
      applyTheme();
      
      renderAll(); 
      setupGlobalDelegation(); 
      setupIndicatorObserver();
      setupGnbScroll();
      window.addEventListener('resize', handleResize);
      handleResize();
      bindStaticEvents();
      ScoreUI.render(state.rooms);
      renderMapView();
      setupTooltipPositioning();

      renderAppGrid('all');
      setupDragScroll(document.getElementById('app-store-grid'));
      
      const pasWrapper = document.getElementById('pas-wrapper');
      if (pasWrapper) {
          pasWrapper.addEventListener('click', () => {
             ScoreUI.toggleNotif(); 
          });
      }
      
      document.getElementById('notif-backdrop').addEventListener('click', ScoreUI.closeNotif);
      document.addEventListener('keydown', (e) => {
         if(e.key === 'Escape') ScoreUI.closeNotif();
      });
    }

    function setupGnbScroll() {
      let lastScrollY = window.scrollY;
      const gnb = document.getElementById('gnb');
      
      window.addEventListener('scroll', () => {
        const currentScrollY = window.scrollY;
        
        // Down scroll & not at top & diff > 10 (sensitivity)
        if (currentScrollY > lastScrollY && currentScrollY > 100) {
           gnb.style.transform = 'translateY(-100%)';
        } else {
           gnb.style.transform = 'translateY(0)';
        }
        
        lastScrollY = currentScrollY;
      }, { passive: true });
    }
    
    function switchView(viewName) {
      state.currentView = viewName;
      const checklistView = document.getElementById('view-checklist');
      const helpView = document.getElementById('view-help');
      
      const pcTabs = document.getElementById('pc-tabs-container');
      const mobileTabsWrapper = document.getElementById('mobile-tabs-wrapper');
      const indicatorArea = document.getElementById('indicator-area');

      const btnExportPc = document.getElementById('btn-export-pc');
      const btnTutoPc = document.getElementById('btn-header-tuto');
      const btnExportMob = document.getElementById('btn-export-mobile');
      const btnTutoMob = document.getElementById('btn-tuto-mobile');

      if (viewName === 'help') {
        checklistView.classList.add('hidden');
        helpView.classList.remove('hidden');
        
        if(pcTabs) pcTabs.parentElement.classList.add('invisible');
        if(mobileTabsWrapper) mobileTabsWrapper.classList.add('hidden');
        if(indicatorArea) indicatorArea.classList.add('hidden');
        
        if(btnExportPc) { btnExportPc.classList.add('hidden'); btnExportPc.classList.remove('md:flex'); }
        if(btnTutoPc) { btnTutoPc.classList.remove('hidden'); btnTutoPc.classList.add('md:flex'); }
        if(btnExportMob) btnExportMob.classList.add('hidden');
        if(btnTutoMob) btnTutoMob.classList.remove('hidden');

        window.scrollTo({top: 0});
      } else {
        checklistView.classList.remove('hidden');
        helpView.classList.add('hidden');
        
        if(pcTabs) pcTabs.parentElement.classList.remove('invisible');
        if(mobileTabsWrapper) mobileTabsWrapper.classList.remove('hidden');
        if(indicatorArea) indicatorArea.classList.remove('hidden');
        
        if(btnExportPc) { btnExportPc.classList.remove('hidden'); btnExportPc.classList.add('md:flex'); }
        if(btnTutoPc) { btnTutoPc.classList.add('hidden'); btnTutoPc.classList.remove('md:flex'); }
        if(btnExportMob) btnExportMob.classList.remove('hidden');
        if(btnTutoMob) btnTutoMob.classList.add('hidden');
      }
      
      renderSidebar();
      renderMobileNav();
    }
    
    function renderMobileNav() {
       const mDev = document.getElementById('mobile-nav-device');
       const mHelp = document.getElementById('mobile-nav-help');
       if(!mDev || !mHelp) return;
       
       const activeClass = "flex flex-col items-center gap-1 p-2 text-brand transition-colors";
       const inactiveClass = "flex flex-col items-center gap-1 p-2 text-slate-400 dark:text-slate-500 transition-colors";
       
       if(state.currentView === 'checklist') {
           mDev.className = activeClass;
           mHelp.className = inactiveClass;
       } else {
           mDev.className = inactiveClass;
           mHelp.className = activeClass;
       }
    }

    function renderAppGrid(filter = 'all') {
      const tabsContainer = document.getElementById('app-filter-tabs');
      const gridContainer = document.getElementById('app-store-grid');
      if(!tabsContainer || !gridContainer) return;
      
      const filters = [
         { id: 'all', label: '전체' }, { id: 'phone', label: '폰' }, { id: 'tab', label: '탭' },
         { id: 'watch', label: '워치' }, { id: 'pc', label: 'PC' }, { id: 'tv', label: 'TV' },
         { id: 'web', label: '웹' },
         { id: 'car', label: '자동차' }
      ];
      
      tabsContainer.innerHTML = filters.map(f => `
        <button onclick="renderAppGrid('${f.id}')" class="px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-all ${filter === f.id ? 'bg-slate-900 dark:bg-white text-white dark:text-slate-900 shadow-md' : 'bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700'}">
          ${f.label}
        </button>
      `).join('');
      
      const APP_LINKS = [
        { name: 'Galaxy Store', tags: ['phone', 'watch'], url: 'https://galaxystore.samsung.com/prepost/000004262296', color: 'bg-pink-500', icon: 'Grid', logo: 'galaxystore.png' },
        { name: 'Play Store', tags: ['phone', 'tab', 'watch'], url: 'https://play.google.com/store/apps/details?id=com.samsung.android.oneconnect&hl=ko', color: 'bg-green-500', icon: 'Play', logo: 'playstore.png' },
        { name: 'App Store', tags: ['phone', 'tab', 'watch'], url: 'https://apps.apple.com/kr/app/samsung-smartthings/id1222822904', color: 'bg-blue-500', icon: 'Box', logo: 'appstore.png' },
        { name: 'Microsoft Store', tags: ['pc'], url: 'https://apps.microsoft.com/detail/9n3zbh5v7hx6?hl=ko-KR&gl=KR', color: 'bg-blue-600', icon: 'Grid', logo: 'microsoft.png' },
        { name: 'Samsung TV', tags: ['tv'], url: 'https://www.samsungsvc.co.kr/solution/2395698?assess=N', color: 'bg-indigo-900', icon: 'Grid', logo: 'samsung.png' },
        { name: 'My SmartThings', tags: ['web'], url: 'https://my.smartthings.com/advanced', color: 'bg-indigo-600', icon: 'Monitor', logo: 'SmartThings.png' },
        { name: 'SmartThings Pro', tags: ['web'], url: 'https://www.smartthingspro.ai/', color: 'bg-indigo-600', icon: 'Monitor', logo: 'SmartThings_Pro.png' },
        { name: 'Pleos', tags: ['car'], url: 'https://news.samsung.com/kr/%EC%82%BC%EC%84%B1%EC%A0%84%EC%9E%90-%ED%98%84%EB%8C%80%EC%9E%90%EB%8F%99%EC%B0%A8%EA%B7%B8%EB%A3%B9%EA%B3%BC-%EC%86%90%EC%9E%A1%EA%B3%A0-%EC%8A%A4%EB%A7%88%ED%8A%B8%ED%99%88-%EC%BB%A4%EB%84%A5', color: 'bg-slate-700', icon: 'Play', logo: 'pleos.png' },
        { name: 'CCNC (현대, 기아)', tags: ['car'], url: 'https://news.samsung.com/kr/%EC%82%BC%EC%84%B1%EC%A0%84%EC%9E%90-%ED%98%84%EB%8C%80%EC%9E%90%EB%8F%99%EC%B0%A8%EA%B7%B8%EB%A3%B9%EA%B3%BC-%EC%86%90%EC%9E%A1%EA%B3%A0-%EC%8A%A4%EB%A7%88%ED%8A%B8%ED%99%88-%EC%BB%A4%EB%84%A5', color: 'bg-blue-800', icon: 'Car', logo: 'ccnc.png' },
        { name: 'CCIC (제네시스)', tags: ['car'], url: 'https://news.samsung.com/kr/%EC%82%BC%EC%84%B1%EC%A0%84%EC%9E%90-%ED%98%84%EB%8C%80%EC%9E%90%EB%8F%99%EC%B0%A8%EA%B7%B8%EB%A3%B9%EA%B3%BC-%EC%86%90%EC%9E%A1%EA%B3%A0-%EC%8A%A4%EB%A7%88%ED%8A%B8%ED%99%88-%EC%BB%A4%EB%84%A5', color: 'bg-black', icon: 'Car', logo: 'ccic.png' }
      ];
      
      const filteredLinks = filter === 'all' ? APP_LINKS : APP_LINKS.filter(l => l.tags.includes(filter));
      
      gridContainer.innerHTML = filteredLinks.map((link, i) => `
        <a href="${link.url}" target="_blank" class="shrink-0 w-56 h-96 bg-white dark:bg-slate-800 rounded-3xl border border-slate-100 dark:border-slate-700 shadow-sm hover:shadow-xl hover:-translate-y-2 transition-all group flex flex-col overflow-hidden snap-center">
          <div class="h-48 ${link.color} relative flex items-center justify-center rounded-t-3xl">
             <div class="w-24 h-24 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center text-white shadow-lg group-hover:scale-110 transition-transform duration-500">
               <img src="images/icons/store/${link.logo}" alt="${link.name}" class="w-14 h-14 object-contain drop-shadow-sm" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
               <div style="display:none">${getIcon(link.icon, 40)}</div>
             </div>
             <div class="absolute bottom-0 inset-x-0 h-20 bg-gradient-to-t from-black/20 to-transparent"></div>
          </div>
          <div class="p-6 flex flex-col flex-1">
            <h4 class="text-xl font-black text-slate-900 dark:text-white mb-2 group-hover:text-brand transition-colors">${link.name}</h4>
            <div class="flex flex-wrap gap-1 mb-auto">
               ${link.tags.map(t => `<span class="text-[10px] uppercase font-bold text-slate-400 bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded">${t}</span>`).join('')}
            </div>
            <div class="flex items-center text-sm font-bold text-slate-500 group-hover:text-brand transition-colors mt-4">
               바로가기 ${getIcon('ExternalLink', 14, 'ml-2')}
            </div>
          </div>
        </a>
      `).join('');
    }

    function bindStaticEvents() {
      const getEl = (id) => document.getElementById(id);
      if(getEl('btn-sidebar-toggle')) getEl('btn-sidebar-toggle').addEventListener('click', toggleSidebar);
      
      if(getEl('btn-export-mobile')) getEl('btn-export-mobile').addEventListener('click', exportToPNG);
      if(getEl('btn-tuto-mobile')) getEl('btn-tuto-mobile').addEventListener('click', TutorialController.open);
      
      if(getEl('btn-gnb-more')) getEl('btn-gnb-more').addEventListener('click', (e) => openGnbPopover(e.currentTarget));
      if(getEl('btn-gnb-notif')) getEl('btn-gnb-notif').addEventListener('click', ScoreUI.toggleNotif); 
      
      if(getEl('btn-footer-png')) getEl('btn-footer-png').addEventListener('click', exportToPNG);

      if(getEl('nav-device')) getEl('nav-device').addEventListener('click', () => switchView('checklist'));
      if(getEl('mobile-nav-device')) getEl('mobile-nav-device').addEventListener('click', () => switchView('checklist'));
      
      if(getEl('nav-help')) getEl('nav-help').addEventListener('click', () => switchView('help'));
      if(getEl('mobile-nav-help')) getEl('mobile-nav-help').addEventListener('click', () => switchView('help'));
    }

    function renderAll() {
      renderHeader();
      renderSidebar();
      renderWidgets();
      renderRooms();
      renderIndicators();
      updateFab();
      renderMobileNav();
      renderAutomationWidgets();
      initMarquees();
    }

    function initMarquees() {
      document.querySelectorAll('.marquee').forEach(marquee => {
        const inner = marquee.querySelector('.marquee__inner');
        if (!inner) return;
        const texts = inner.querySelectorAll('.marquee-text');
        if (texts.length < 2) return;
        const first = texts[0];
        const duplicate = texts[1];

        // Reset to allow recalculation
        inner.style.animation = 'none';
        inner.style.transform = 'none';
        duplicate.style.display = 'inline-block';
        first.style.marginRight = '0px';

        const containerWidth = marquee.clientWidth;
        const contentWidth = first.offsetWidth;
        const gapPx = 20;

        if (contentWidth <= containerWidth) {
          duplicate.style.display = 'none';
        } else {
          const translateDistance = contentWidth + gapPx;
          inner.style.setProperty('--marquee-translate', `${translateDistance}px`);
          first.style.marginRight = `${gapPx}px`;
          
          const pxPerSecond = 20;
          const durationSeconds = translateDistance / pxPerSecond;
          inner.style.animation = `marquee-slide ${durationSeconds}s linear infinite`;
        }
      });
    }

    function applyTheme() {
      const root = document.documentElement;
      if (state.theme === 'dark') root.classList.add('dark');
      else root.classList.remove('dark');
    }

    function handleResize() {
      const w = window.innerWidth;
      
      if (w < 768) state.sidebarMode = 'hidden';
      else if (w < 1280) state.sidebarMode = 'collapsed';
      else state.sidebarMode = 'expanded';
      
      if (w >= 768) {
        let changed = false;
        state.rooms.forEach(r => {
          r.rows.forEach(row => {
            if (row.isSlim) {
              row.isSlim = false;
              changed = true;
            }
          });
        });
        if (changed) {
          saveRooms(); 
          renderRooms(); 
        }
      }

      renderSidebar();
      renderMainLayoutClass();
      initMarquees();
    }

    function renderMainLayoutClass() {
      const main = document.getElementById('main-content');
      const sidebar = document.getElementById('sidebar');
      if(state.sidebarMode === 'hidden') {
        sidebar.classList.add('hidden'); sidebar.classList.remove('flex');
        main.className = `flex-1 transition-all duration-300 min-w-0`;
      } else {
        sidebar.classList.remove('hidden'); sidebar.classList.add('flex');
        main.className = `flex-1 transition-all duration-300 min-w-0 ${state.sidebarMode === 'expanded' ? 'md:ml-52' : 'md:ml-20'}`;
      }
    }

    function toggleSidebar() {
      state.sidebarMode = state.sidebarMode === 'expanded' ? 'collapsed' : 'expanded';
      renderSidebar();
      renderMainLayoutClass();
    }

    // Render Functions
    function renderHeader() {
      const menuBtn = document.getElementById('btn-sidebar-toggle');
      if(menuBtn && !menuBtn.innerHTML.includes('<svg')) menuBtn.innerHTML = getIcon('Menu', 20);
      const moreBtn = document.getElementById('btn-gnb-more');
      if(moreBtn && !moreBtn.innerHTML.includes('<svg')) moreBtn.innerHTML = getIcon('MoreHorizontal', 20);

      const generateTabs = () => {
        let html = state.rooms.map((r, i) => `
          <button data-action="select-room" data-idx="${i}" 
            class="px-4 py-1.5 rounded-full text-sm font-bold whitespace-nowrap transition-all ${state.activeRoomIdx === i ? 'bg-slate-900 dark:bg-white text-white dark:text-slate-900' : 'text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800'}">
            ${r.name || '이름없음'}
          </button>
        `).join('');
        html += `<button data-action="add-room" class="px-3 py-1.5 rounded-full text-sm font-bold text-brand hover:bg-brand/10 whitespace-nowrap flex items-center gap-1">${getIcon('Plus', 14)} ${window.innerWidth >= 768 ? '방 추가' : ''}</button>`;
        return html;
      };
      
      const pcTabs = document.getElementById('pc-tabs-container');
      const mobileTabs = document.getElementById('mobile-tabs-container');
      if(pcTabs) { pcTabs.innerHTML = generateTabs(); setupDragScroll(pcTabs); }
      if(mobileTabs) { mobileTabs.innerHTML = generateTabs(); setupDragScroll(mobileTabs); }
    }

    function renderSidebar() {
      const sidebar = document.getElementById('sidebar');
      const deviceBtn = document.getElementById('nav-device');
      const helpBtn = document.getElementById('nav-help');
      
      if (deviceBtn && !deviceBtn.querySelector('svg')) deviceBtn.insertAdjacentHTML('afterbegin', getIcon('Smartphone', 20, 'shrink-0'));
      if (helpBtn && !helpBtn.querySelector('svg')) helpBtn.insertAdjacentHTML('afterbegin', getIcon('HelpCircle', 20, 'shrink-0'));

      const textSpans = sidebar.querySelectorAll('button > span');
      
      const activeStyle = `bg-white/50 dark:bg-slate-800/50 hover:bg-white dark:hover:bg-slate-800 text-brand border-slate-100 dark:border-slate-700 shadow-sm font-bold`;
      const inactiveStyle = `hover:bg-white/50 dark:hover:bg-slate-800/50 text-slate-500 dark:text-slate-400 hover:border-slate-100 dark:hover:border-slate-700 border-transparent font-bold`;

      if (state.sidebarMode === 'expanded') {
        sidebar.classList.replace('w-16', 'w-48'); sidebar.classList.remove('items-center');
        
        deviceBtn.className = `flex items-center gap-3 rounded-xl border transition-all text-left px-4 py-3 ${state.currentView === 'checklist' ? activeStyle : inactiveStyle}`;
        helpBtn.className = `flex items-center gap-3 rounded-xl border transition-all text-left px-4 py-3 ${state.currentView === 'help' ? activeStyle : inactiveStyle}`;
        
        textSpans.forEach(s => s.style.display = 'inline');
      } else {
        sidebar.classList.replace('w-48', 'w-16'); sidebar.classList.add('items-center');
        
        const activeCollapsed = `bg-white dark:bg-slate-800 text-brand border-slate-100 dark:border-slate-700`;
        const inactiveCollapsed = `hover:bg-white/50 dark:hover:bg-slate-800/50 text-slate-500 dark:text-slate-400 border-transparent`;
        
        deviceBtn.className = `p-3 justify-center rounded-xl border flex ${state.currentView === 'checklist' ? activeCollapsed : inactiveCollapsed}`;
        helpBtn.className = `p-3 justify-center rounded-xl border flex ${state.currentView === 'help' ? activeCollapsed : inactiveCollapsed}`;
        
        textSpans.forEach(s => s.style.display = 'none');
      }
    }
    
    function escapeHtml (unsafe) {
      return unsafe.replace(/[&<"'>]/g, function(m) {
        switch (m) {
          case '&': return '&amp;';
          case '<': return '&lt;';
          case '>': return '&gt;';
          case '"': return '&quot;';
          case "'": return '&#039;';
          default: return m;
        }
      });
    }

    function renderRooms() {
      const container = document.getElementById('rooms-area');
      container.innerHTML = '';
      state.rooms.forEach((room, rIdx) => {
        const section = document.createElement('section');
        section.className = "room-card bg-white/70 dark:bg-slate-900/50 backdrop-blur-md border border-white/40 dark:border-slate-800 shadow-xl shadow-slate-200/40 dark:shadow-none rounded-[2rem] p-1 md:p-6 overflow-hidden relative";
        section.dataset.roomIdx = rIdx;
        
        const headerHTML = `
          <div class="flex items-center justify-between mb-6 px-4 pt-4 md:pt-0">
            <input type="text" value="${room.name}" data-room="${rIdx}" data-field="room-name" class="room-name-input text-2xl font-black bg-transparent border-none outline-none placeholder:text-slate-300 dark:placeholder:text-slate-600 text-slate-800 dark:text-white w-full max-w-md" placeholder="방 이름 입력" maxlength="20">
            <div class="flex items-center gap-2">
              <button data-action="add-row" data-room="${rIdx}" class="hidden md:flex bg-blue-50 dark:bg-brand/20 text-brand dark:text-brand-light hover:bg-brand hover:text-white px-3 py-1.5 rounded-full text-sm font-bold transition-all">+ 기기 추가</button>
              <button data-action="room-more" data-room="${rIdx}" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full text-slate-400">${getIcon('MoreHorizontal', 20)}</button>
            </div>
          </div>`;
        
        if (room.rows.length === 0) {
          section.innerHTML = headerHTML + `
            <div class="border-2 border-dashed border-slate-200 dark:border-slate-800 rounded-2xl p-8 flex flex-col items-center justify-center gap-4 text-center mx-4 mb-4">
              <div class="text-slate-400 dark:text-slate-500 font-medium">이 방에는 아직 기기가 없습니다.</div>
              <div class="flex gap-3">
                <button data-action="add-row" data-room="${rIdx}" class="px-4 py-2 bg-brand text-white rounded-full font-bold text-sm shadow-lg shadow-brand/20 hover:scale-105 transition-transform">기기 추가</button>
                <button data-action="preset-modal" data-room="${rIdx}" class="px-4 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 rounded-full font-bold text-sm hover:bg-slate-50 dark:hover:bg-slate-700">프리셋 추가</button>
              </div>
            </div>`;
        } else {
          let rowsHtml = '';
          room.rows.forEach((row, rowIdx) => {
            const isSlim = row.isSlim === true;
            
            // [수정됨] 사용자가 입력한 동의어(예: 무드등)를 표준 프로필 이름(예: 조명)으로 변환하여 아이콘을 찾습니다.
            const profileName = getProfileName(row.device);
            const filename = DEVICE_ICON_MAP[profileName] || 'other';
            
            const imgSrc = `images/icons/deviceprofiles/${filename}.png`;
            const webpSrc = `images/icons/deviceprofiles/${filename}.webp`;

            const slimRowHtml = isSlim ? `
              <div class="md:hidden flex items-center gap-3 p-2 bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 rounded-full shadow-sm active:scale-95 transition-all cursor-pointer row-tracker" data-row-id="${row.__rid}" data-action="unslim-row" data-room="${rIdx}" data-row="${rowIdx}">
                <div class="w-12 h-12 rounded-full bg-blue-50 dark:bg-slate-700 border border-blue-100 dark:border-slate-600 flex items-center justify-center shrink-0 overflow-hidden p-1">
                   <img src="${imgSrc}" onerror="this.src='${webpSrc}';this.onerror=()=>{this.parentElement.innerText='🔘'}" class="w-full h-full object-contain">
                </div>
                <div class="flex-1 overflow-hidden min-w-0">
                   <div class="marquee">
                      <div class="marquee__inner">
                        <span class="marquee-text inline-block text-sm font-bold text-slate-800 dark:text-white mr-4">${escapeHtml(row.device || '기기 선택')}</span>
                        <span class="marquee-text inline-block text-sm font-bold text-slate-800 dark:text-white" aria-hidden="true">${escapeHtml(row.device || '기기 선택')}</span>
                      </div>
                   </div>
                   <div class="flex items-center gap-1 mt-0.5">
                     <span class="text-[10px] bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400 px-1.5 rounded font-medium truncate max-w-[140px]">${row.protocol || '-'}</span>
                     <span class="text-[10px] text-slate-400 font-bold text-brand-light pr-2 shrink-0">x${row.qty}</span>
                   </div>
                </div>
                <button data-action="row-more" data-room="${rIdx}" data-row-id="${row.__rid}" class="p-2 text-slate-400 hover:text-brand">${getIcon('MoreHorizontal', 18)}</button>
              </div>
            ` : '';

            const inputDisplayClass = isSlim ? 'hidden md:table-row' : 'flex flex-col md:table-row';

            rowsHtml += `
              ${slimRowHtml}
              <tr class="${inputDisplayClass} bg-white dark:bg-slate-800 md:bg-transparent border border-slate-100 dark:border-slate-800 md:border-b md:border-slate-100/50 dark:md:border-slate-700/50 rounded-3xl md:rounded-none shadow-sm md:shadow-none p-4 md:p-0 relative group hover:bg-slate-50/50 dark:hover:bg-slate-800/30 transition-colors row-tracker" data-row-id="${row.__rid}">
                <td class="p-1 md:p-3 block md:table-cell relative">
                  <span class="md:hidden text-xs font-bold text-slate-400 mb-1 block">디바이스</span>
                  <input class="w-full bg-transparent border border-transparent hover:border-slate-200 focus:border-brand-light focus:bg-white dark:focus:bg-slate-800 rounded-xl py-2.5 pr-10 pl-4 text-slate-800 dark:text-slate-100 placeholder:text-slate-400 outline-none transition-all"
                    value="${row.device}" placeholder="디바이스 이름" data-room="${rIdx}" data-row="${rowIdx}" data-field="device" data-ac-type="device">
                  <div class="absolute right-2 top-[34px] md:top-[20px] z-10">
                    <button data-action="device-modal" data-room="${rIdx}" data-row="${rowIdx}" class="p-1.5 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-md text-brand">${getIcon('Plus', 16)}</button>
                  </div>
                </td>
                <td class="p-1 md:p-3 block md:table-cell relative">
                  <span class="md:hidden text-xs font-bold text-slate-400 mb-1 block">프로토콜</span>
                  <input class="w-full bg-transparent border border-transparent hover:border-slate-200 focus:border-brand-light focus:bg-white dark:focus:bg-slate-800 rounded-xl py-2.5 pr-10 pl-4 text-slate-800 dark:text-slate-100 placeholder:text-slate-400 outline-none transition-all"
                    value="${row.protocol}" placeholder="예: Zigbee" data-room="${rIdx}" data-row="${rowIdx}" data-field="protocol" data-ac-type="protocol">
                </td>
                
                <td class="p-1 md:p-3 block md:table-cell">
                  <div class="flex items-center justify-between md:justify-center gap-2 md:w-full">
                    <span class="md:hidden text-xs font-bold text-slate-400">수량</span>
                    <div class="flex items-center bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl px-2 py-1">
                      <button data-action="qty-dec" data-room="${rIdx}" data-row="${rowIdx}" class="w-6 h-6 flex items-center justify-center text-slate-400 hover:text-brand font-bold">-</button>
                      <input type="number" value="${row.qty}" class="qty-input w-8 text-center bg-transparent font-bold text-slate-800 dark:text-slate-200 outline-none text-sm" data-room="${rIdx}" data-row="${rowIdx}">
                      <button data-action="qty-inc" data-room="${rIdx}" data-row="${rowIdx}" class="w-6 h-6 flex items-center justify-center text-slate-400 hover:text-brand font-bold">+</button>
                    </div>
                  </div>
                </td>
                
                <td class="p-1 pt-4 md:hidden block">
                   <button data-action="confirm-row" data-room="${rIdx}" data-row="${rowIdx}" class="w-full py-3 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-slate-200 dark:shadow-none active:scale-95 transition-transform">
                     ${getIcon('Check', 18)} 확인
                   </button>
                </td>

                <td class="hidden md:table-cell p-1 md:p-3 text-center">
                  <button data-action="row-more" data-room="${rIdx}" data-row-id="${row.__rid}" class="p-2 text-slate-400 hover:text-brand hover:bg-blue-50 dark:hover:bg-slate-700 rounded-full transition-colors">${getIcon('MoreHorizontal', 18)}</button>
                </td>
                
                <td class="md:hidden absolute top-2 right-2">
                   <button data-action="row-more" data-room="${rIdx}" data-row-id="${row.__rid}" class="p-2 text-slate-400 hover:text-brand hover:bg-blue-50 dark:hover:bg-slate-700 rounded-full transition-colors">${getIcon('MoreHorizontal', 18)}</button>
                </td>
              </tr>`;
          });
          section.innerHTML = headerHTML + `
            <div class="overflow-x-auto md:overflow-visible p-3 space-y-1">
              <table class="w-full text-left border-collapse">
                <thead class="hidden md:table-header-group">
                  <tr>
                    <th class="p-3 text-xs text-slate-400 font-bold uppercase tracking-wider w-[45%]">디바이스</th>
                    <th class="p-3 text-xs text-slate-400 font-bold uppercase tracking-wider w-[35%]">프로토콜</th>
                    <th class="p-3 text-xs text-slate-400 font-bold uppercase tracking-wider w-[15%] text-center">수량</th>
                    <th class="p-3 w-[5%]"></th>
                  </tr>
                </thead>
                <tbody class="block md:table-row-group space-y-3 md:space-y-0 md:px-0 pb-3 md:pb-0">${rowsHtml}</tbody>
              </table>
            </div>
            <div class="md:hidden px-4 pb-4 mt-3">
              <button data-action="add-row" data-room="${rIdx}" class="w-full py-3 rounded-xl border-2 border-dashed border-brand/30 text-brand dark:text-brand-light font-bold bg-blue-50/50 dark:bg-brand/10 hover:bg-blue-50 dark:hover:bg-brand/20 flex items-center justify-center gap-2">${getIcon('Plus', 18)} 기기 추가</button>
            </div>`;
        }
        container.appendChild(section);
      });
    }

    function renderIndicators() {
      const container = document.getElementById('indicator-area');
      const isMapVisible = state.visibleRowIds.has('map-view');

      let html = `
        <div class="mb-2 transition-all duration-300 ${isMapVisible ? 'text-brand scale-110 drop-shadow-md' : 'text-slate-300 dark:text-slate-600'}">
            ${getIcon('Home', 10, 'fill-current')}
        </div>
      `;

      html += state.rooms.map((room, rIdx) => `
        <div class="flex flex-col gap-1 items-center">
          ${room.rows.map(row => `
            <div class="w-2 h-2 rounded-full transition-all duration-300 ${state.visibleRowIds.has(row.__rid) ? 'bg-brand scale-125 shadow-brand/50 shadow-lg opacity-100' : 'bg-slate-300 dark:bg-slate-600 opacity-40 scale-90'}"></div>
          `).join('')}
          ${rIdx < state.rooms.length - 1 && room.rows.length > 0 ? '<div class="h-4 w-[1px] bg-slate-200 dark:bg-slate-700 my-1"></div>' : ''}
        </div>
      `).join('');
      
      container.innerHTML = html;
    }

    function updateFab() {
      const fab = document.getElementById('btn-export-mobile');
      if (fab && !fab.querySelector('svg')) fab.insertAdjacentHTML('afterbegin', getIcon('Camera', 20));
      
      const navDev = document.getElementById('mobile-nav-device');
      const navHelp = document.getElementById('mobile-nav-help');
      if (navDev && !navDev.querySelector('svg')) navDev.insertAdjacentHTML('afterbegin', getIcon('Smartphone', 24));
      if (navHelp && !navHelp.querySelector('svg')) navHelp.insertAdjacentHTML('afterbegin', getIcon('HelpCircle', 24));

      const tutoFab = document.getElementById('btn-tuto-mobile');
      if (tutoFab && !tutoFab.querySelector('svg')) tutoFab.insertAdjacentHTML('afterbegin', getIcon('Book', 20));
    }

    // Event Listeners
    function setupGlobalDelegation() {
      document.body.addEventListener('click', (e) => {
        // 1. Autocomplete Item (Early return)
        if(e.target.closest('.ac-item')) return; 

        // 2. Input Autocomplete Trigger (Early return)
        if (e.target.tagName === 'INPUT' && e.target.dataset.acType) {
            showAutocomplete(e.target);
            return;
        }

        // 3. Button Actions (Prioritize over row clicks)
        const target = e.target.closest('button');
        if (target && target.dataset.action) {
           const action = target.dataset.action;
           e.stopPropagation(); // Stop bubbling to prevent triggering parent row clicks

           if (action === 'select-room') {
             const idx = Number(target.dataset.idx);
             state.activeRoomIdx = idx;
             renderHeader(); 
             const els = document.querySelectorAll('.room-card');
             if(els[idx]) {
                const y = els[idx].getBoundingClientRect().top + window.scrollY - 140;
                window.scrollTo({ top: y, behavior: 'smooth' });
             }
           }
           else if (action === 'add-room') {
             state.rooms.push({ name: '새 방', rows: [] });
             state.activeRoomIdx = state.rooms.length - 1;
             saveRooms();
             renderAll();
             setTimeout(() => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }), 100);
           }
           else if (action === 'add-row') {
             const rIdx = Number(target.dataset.room);
             state.rooms[rIdx].rows.push({ __rid: Math.random().toString(36).slice(2), device: '', protocol: '', qty: 1, isSlim: false });
             saveRooms(); renderAll(); 
           }
           else if (action === 'confirm-row') {
             const rIdx = Number(target.dataset.room);
             const rowIdx = Number(target.dataset.row);
             const row = state.rooms[rIdx].rows[rowIdx];
             
             if (!row.device || !row.protocol || !row.qty) {
                alert("입력이 완료되지 않았습니다.\n디바이스, 프로토콜, 수량을 모두 입력해주세요.");
                return;
             }
             row.isSlim = true;
             saveRooms(); 
             renderAll();
           }
           else if (action === 'room-more') openRoomPopover(target, Number(target.dataset.room));
           else if (action === 'row-more') openRowPopover(target, Number(target.dataset.room), target.dataset.rowId);
           else if (action === 'qty-inc' || action === 'qty-dec') {
             const rIdx = Number(target.dataset.room);
             const rowIdx = Number(target.dataset.row);
             let val = state.rooms[rIdx].rows[rowIdx].qty;
             val = action === 'qty-inc' ? Math.min(99, val + 1) : Math.max(1, val - 1);
             state.rooms[rIdx].rows[rowIdx].qty = val;
             saveRooms();
             const input = document.querySelector(`input.qty-input[data-room="${rIdx}"][data-row="${rowIdx}"]`);
             if(input) input.value = val;
             renderWidgets(); 
           }
           else if (action === 'device-modal') openDeviceModal(Number(target.dataset.room), Number(target.dataset.row));
           else if (action === 'preset-modal') openPresetModal(Number(target.dataset.room));
           
           return; // Stop execution here
        }

        // 4. Unslim Row (Click on row background, but not a button)
        const unslimTarget = e.target.closest('[data-action="unslim-row"]');
        if (unslimTarget) {
            const rIdx = Number(unslimTarget.dataset.room);
            const rowIdx = Number(unslimTarget.dataset.row);
            state.rooms[rIdx].rows[rowIdx].isSlim = false;
            saveRooms();
            renderAll();
            return;
        }
      });

      document.body.addEventListener('input', (e) => {
        if (e.target.dataset.field === 'room-name') {
          const idx = Number(e.target.dataset.room);
          state.rooms[idx].name = e.target.value;
          saveRooms();
          document.querySelectorAll(`button[data-action="select-room"][data-idx="${idx}"]`).forEach(b => b.innerText = e.target.value || '이름없음');
        }
        else if (e.target.dataset.field) {
          const rIdx = Number(e.target.dataset.room);
          const rowIdx = Number(e.target.dataset.row);
          const field = e.target.dataset.field;
          state.rooms[rIdx].rows[rowIdx][field] = e.target.value;
          saveRooms();
          if (field === 'device') {
            renderWidgets();
          }
          if (e.target.dataset.acType) showAutocomplete(e.target);
        }
        else if (e.target.classList.contains('qty-input')) {
           const rIdx = Number(e.target.dataset.room);
           const rowIdx = Number(e.target.dataset.row);
           let val = parseInt(e.target.value) || 1;
           if(val < 1) val = 1; if(val > 99) val = 99;
           state.rooms[rIdx].rows[rowIdx].qty = val;
           saveRooms(); renderWidgets();
        }
      });
    }

    function showAutocomplete(input) {
      const type = input.dataset.acType;
      const val = input.value.toLowerCase().trim();
      let candidates = [];
      if (type === 'device') candidates = DEVICE_CATEGORIES.flatMap(c => DEVICE_PROFILE[c]);
      else if (type === 'protocol') candidates = PROTOCOLS;

      const filtered = val ? candidates.filter(c => c.toLowerCase().includes(val)) : candidates.slice(0, 50);
      const root = document.getElementById('autocomplete-root');
      if (filtered.length === 0) { root.innerHTML = ''; return; }

      const rect = input.getBoundingClientRect();
      root.innerHTML = `
        <div class="absolute bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 shadow-xl rounded-xl z-[9999] max-h-60 overflow-auto flex flex-col"
             style="top: ${rect.bottom + window.scrollY + 4}px; left: ${rect.left + window.scrollX}px; width: ${Math.max(rect.width, 220)}px;">
           ${filtered.map(item => {
              const regex = new RegExp(`(${val})`, 'gi');
              const label = val ? item.replace(regex, '<mark class="bg-brand-light/30 text-brand-dark dark:text-brand-light rounded px-0.5">$1</mark>') : item;
              return `<div class="ac-item px-4 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer text-sm text-slate-700 dark:text-slate-200" data-val="${item}">${label}</div>`;
           }).join('')}
        </div>`;

      const handler = (e) => {
        const target = e.target.closest('.ac-item');
        if (target) {
          input.value = target.dataset.val;
          input.dispatchEvent(new Event('input', { bubbles: true })); 
          root.innerHTML = '';
          document.removeEventListener('mousedown', outsideClick);
        }
      };
      const outsideClick = (e) => {
         if (!root.contains(e.target) && e.target !== input) {
           root.innerHTML = '';
           document.removeEventListener('mousedown', outsideClick);
         }
      };
      root.onclick = handler;
      setTimeout(() => document.addEventListener('mousedown', outsideClick), 0);
    }

    /* Smooth drag + inertia + multi-item snap for horizontal containers
   Usage: setupDragScroll(containerElement)
   Will compute snap positions (centers of children + edges)
    */
    function setupDragScroll(ele) {
      if (!ele || ele.__st_drag_init) return;
      ele.__st_drag_init = true;

      // 1. 기존 CSS 스냅 및 스무스 동작 제거 (JS 물리 엔진 적용을 위해 필수)
      ele.style.scrollSnapType = 'none';
      ele.style.scrollBehavior = 'auto';
      ele.style.cursor = 'grab';

      // 상태 변수
      let isDown = false;
      let startX;
      let scrollLeft;
      let velX = 0;       // 현재 속도
      let lastX = 0;      // 속도 계산용 이전 위치
      let lastTime = 0;   // 속도 계산용 시간
      let momentumID;     // 관성 애니메이션 프레임 ID
      let isDragging = false; // 단순 클릭인지 드래그인지 판별

      // 관성 루프 (Physics Loop)
      const momentumLoop = () => {
        // 마찰력 적용 (0.95: 빙판길 ~ 0.85: 흙길)
        velX *= 0.95;

        // 속도가 거의 0이면 정지
        if (Math.abs(velX) < 0.5) {
          cancelAnimationFrame(momentumID);
          // 관성 종료 후 스냅 복구 (Glide)
          ele.style.scrollBehavior = 'smooth';
          ele.style.scrollSnapType = 'x proximity';
          return;
        }

        // 스크롤 적용
        ele.scrollLeft -= velX;

        // 바운더리 체크 (스크롤 끝에 도달하면 속도 0)
        if (ele.scrollLeft <= 0 || ele.scrollLeft >= ele.scrollWidth - ele.clientWidth) {
          velX = 0;
          cancelAnimationFrame(momentumID);
          ele.style.scrollBehavior = 'smooth';
          ele.style.scrollSnapType = 'x proximity';
          return;
        }

        momentumID = requestAnimationFrame(momentumLoop);
      };

      // 공통 이벤트 핸들러 (마우스/터치 좌표 추출)
      const getPageX = (e) => {
        return e.touches ? e.touches[0].pageX : e.pageX;
      };

      const onDown = (e) => {
        isDown = true;
        isDragging = false;
        ele.style.cursor = 'grabbing';
        ele.classList.add('st-dragging');

        // 기존 관성 멈춤 & 스냅 해제 (즉각 반응)
        cancelAnimationFrame(momentumID);
        ele.style.scrollBehavior = 'auto';
        ele.style.scrollSnapType = 'none';

        // 초기값 설정
        const pageX = getPageX(e);
        startX = pageX - ele.offsetLeft;
        scrollLeft = ele.scrollLeft;

        // 속도 계산 초기화
        lastX = pageX;
        lastTime = performance.now();
        velX = 0;

        // 이미지나 텍스트 드래그 방지 (PC에서 링크 선택 방지)
        // [중요] 링크/이미지 드래그 시 브라우저 기본 동작 막음 -> 스크롤 우선
        if (!e.touches) {
          e.preventDefault(); 
        }
      };

      const onMove = (e) => {
        if (!isDown) return;
        if (e.touches) { 
           // 터치 시 세로 스크롤 의도가 강하면 가로 드래그 무시 (모바일 UX)
           // 필요하다면 e.preventDefault()를 호출하여 가로 전용으로 만들 수 있음
        } else {
           e.preventDefault(); 
        }

        const pageX = getPageX(e);
        const x = pageX - ele.offsetLeft;
        const walk = (x - startX); // 이동 거리

        // 5px 이상 움직이면 드래그로 간주 (클릭 방지용)
        if (Math.abs(walk) > 5) {
          isDragging = true;
        }

        // 스크롤 이동
        ele.scrollLeft = scrollLeft - walk;

        // 속도 계산
        const now = performance.now();
        const dt = now - lastTime;
        const dx = pageX - lastX;

        if (dt > 0) {
          // 순간 속도 계산 (가중치 0.8을 두어 급격한 변화 보정)
          const newVel = (dx / dt) * 16; // 60fps 기준 보정
          velX = newVel * 0.8 + velX * 0.2;
        }

        lastX = pageX;
        lastTime = now;
      };

      const onUp = (e) => {
        isDown = false;
        ele.style.cursor = 'grab';
        ele.classList.remove('st-dragging');

        if (isDragging) {
          // 드래그 상태였다면 관성 실행
          momentumLoop();

          // 드래그 후 클릭 이벤트 발생 방지 (캡처링 단계에서 중단)
          const preventClick = (ev) => {
            ev.stopPropagation();
            ev.preventDefault();
            window.removeEventListener('click', preventClick, true);
          };
          window.addEventListener('click', preventClick, true);
        } else {
          // 드래그 아니면 바로 스냅 복구
          ele.style.scrollBehavior = 'smooth';
          ele.style.scrollSnapType = 'x proximity';
        }
      };

      const onLeave = () => {
        if (isDown) onUp();
      };

      // 휠 이벤트: 세로 휠을 가로 스크롤로 변환 (스냅 없음)
      const onWheel = (e) => {
        // 세로 스크롤이 주된 입력일 때만 변환
        if (Math.abs(e.deltaY) > Math.abs(e.deltaX)) {
          e.preventDefault();
          // 휠은 관성 없이 즉각 반응하거나, 필요 시 부드럽게 처리 가능
          // 여기서는 기본 스크롤 동작을 따르되 가로로 맵핑
          ele.scrollLeft += e.deltaY;
        }
      };

      // 드래그 시작 시점의 기본 동작(이미지 드래그 등) 방지
      ele.addEventListener('dragstart', (e) => e.preventDefault());

      // 이벤트 리스너 등록
      ele.addEventListener('mousedown', onDown);
      ele.addEventListener('mousemove', onMove);
      ele.addEventListener('mouseup', onUp);
      ele.addEventListener('mouseleave', onLeave);

      ele.addEventListener('touchstart', onDown, { passive: true }); // passive: true로 스크롤 성능 최적화
      ele.addEventListener('touchmove', onMove, { passive: false }); // preventDefault 사용 가능하도록 false
      ele.addEventListener('touchend', onUp);

      ele.addEventListener('wheel', onWheel, { passive: false });
    }
    
    
    function openModal(contentHTML, title, backCallback = null) {
      const root = document.getElementById('modal-root');
      root.innerHTML = `
        <div class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm" id="modal-backdrop">
          <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl w-full max-w-3xl max-h-[85vh] flex flex-col overflow-hidden animate-in fade-in zoom-in duration-200 border border-slate-100 dark:border-slate-800">
            <div class="flex items-center justify-between p-4 border-b border-slate-100 dark:border-slate-800 shrink-0 bg-white dark:bg-slate-900">
              <div class="flex items-center gap-2">
                ${backCallback ? `<button id="modal-back" class="p-1 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full dark:text-slate-100">${getIcon('ArrowLeft', 20)}</button>` : ''}
                <h3 class="font-bold text-lg text-slate-800 dark:text-white">${title}</h3>
              </div>
              <button id="modal-close" class="p-1 text-slate-400 hover:text-slate-600 hover:bg-slate-100 dark:hover:bg-slate-800 dark:hover:text-slate-200 rounded-full">${getIcon('X', 20)}</button>
            </div>
            <div class="overflow-auto p-0 flex-1">${contentHTML}</div>
          </div>
        </div>`;
      document.getElementById('modal-close').onclick = () => root.innerHTML = '';
      document.getElementById('modal-backdrop').onclick = (e) => { if(e.target === e.currentTarget) root.innerHTML = ''; };
      if(backCallback) document.getElementById('modal-back').onclick = backCallback;
    }
    
    // [수정된 부분] 초기화 함수: 선택자를 ID(#)로 정확히 변경
    function initDragForAll() {
      // 기존 코드에서 '.app-filter-tabs' -> '#app-filter-tabs' 로 변경되었습니다.
      // 확실하게 작동하도록 주요 스크롤 영역 ID를 모두 포함했습니다.
      const selectors = [
        '#app-filter-tabs',       // 앱 필터 탭 (이게 빠져 있었음)
        '#pc-tabs-container',     // PC 상단 탭
        '#mobile-tabs-container', // 모바일 상단 탭
        '#device-cat-tabs',       // 디바이스 모달 내부 탭
        '#app-store-grid'         // 앱 스토어 가로 그리드
      ];

      selectors.forEach(sel => {
        const el = document.querySelector(sel);
        if (el) {
          setupDragScroll(el);

          // 스타일 보정: 가로 스크롤이 확실히 되도록 스타일 강제
          el.style.overflowX = 'auto';
          el.style.whiteSpace = 'nowrap';
          el.style.display = 'flex';       // Flex로 배치
          el.style.flexWrap = 'nowrap';    // 줄바꿈 방지
          el.style.webkitOverflowScrolling = 'touch';

          // 스크롤바 숨기기 (선택사항)
          el.classList.add('no-scrollbar'); 
        }
      });
    }
    // call once on load
    initDragForAll();
    // If your app dynamically inserts these containers later, call initDragForAll() again after insertion

    function openDeviceModal(rIdx, rowIdx) {
      const cats = DEVICE_CATEGORIES;
      const html = `
        <div class="flex flex-col h-full">
          <div class="sticky top-0 z-10 bg-white/95 dark:bg-slate-900/95 backdrop-blur-sm border-b border-slate-100 dark:border-slate-800 px-2 py-3">
            <div id="device-cat-tabs" class="flex gap-2 overflow-x-auto no-scrollbar pb-1 mask-linear-sides cursor-grab select-none">
              ${cats.map((c, i) => `<button class="px-4 py-1.5 rounded-full text-sm font-bold whitespace-nowrap transition-all ${i === 0 ? 'bg-slate-900 dark:bg-white text-white dark:text-slate-900 shadow-md' : 'text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800'}" data-cat="${c}">${c}</button>`).join('')}
            </div>
          </div>
          <div id="device-grid" class="p-4 overflow-y-auto flex-1 bg-slate-50 dark:bg-slate-950/50">
            ${cats.map(cat => `
              <div id="cat-section-${cat}" class="mb-8 scroll-mt-4">
                <h4 class="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wider">${cat}</h4>
                <div class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-5 gap-3">
                  ${(DEVICE_PROFILE[cat] || []).map(dev => {
                    const filename = DEVICE_ICON_MAP[dev] || 'other';
                    const imgSrc = `images/icons/deviceprofiles/${filename}.png`;
                    const webpSrc = `images/icons/deviceprofiles/${filename}.webp`;
                    return `
                    <div class="bg-white dark:bg-slate-800 p-3 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm hover:shadow-md hover:border-brand/30 dark:hover:border-brand/50 cursor-pointer flex flex-col items-center gap-3 transition-all active:scale-95" data-device="${dev}">
                      <div class="w-14 h-14 rounded-2xl bg-gradient-to-b from-blue-50 to-blue-100 dark:from-slate-700 dark:to-slate-600 flex items-center justify-center text-2xl shadow-inner border border-blue-100 dark:border-slate-600 overflow-hidden p-1">
                        <img src="${imgSrc}" onerror="this.src='${webpSrc}';this.onerror=()=>{this.parentElement.innerText='🔘'}" class="w-full h-full object-contain">
                      </div>
                      <span class="text-xs font-medium text-slate-700 dark:text-slate-300 text-center line-clamp-2 leading-tight">${dev}</span>
                    </div>`;
                  }).join('')}
                </div>
              </div>`).join('')}
          </div>
        </div>`;
      openModal(html, '디바이스 선택');
      setupDragScroll(document.getElementById('device-cat-tabs'));
      document.getElementById('device-grid').onclick = (e) => {
        const card = e.target.closest('[data-device]');
        if(card) {
          state.rooms[rIdx].rows[rowIdx].device = card.dataset.device;
          saveRooms(); renderAll(); 
          document.getElementById('modal-root').innerHTML = '';
        }
      };
      document.getElementById('device-cat-tabs').onclick = (e) => {
        const target = e.target.closest('[data-cat]');
        if(target) {
          const cat = target.dataset.cat;
          document.getElementById(`cat-section-${cat}`).scrollIntoView({behavior:'smooth', block:'start'});
          const tabs = document.getElementById('device-cat-tabs');
          Array.from(tabs.children).forEach(b => b.className = "px-4 py-1.5 rounded-full text-sm font-bold whitespace-nowrap transition-all text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800");
          target.className = "px-4 py-1.5 rounded-full text-sm font-bold whitespace-nowrap transition-all bg-slate-900 dark:bg-white text-white dark:text-slate-900 shadow-md";
        }
      };
    }

    function openPresetModal(rIdx) {
      const html = `
        <div class="divide-y divide-slate-100 dark:divide-slate-800">
          ${DEFAULT_PRESETS.map((p, i) => `
            <div class="p-4 flex items-center justify-between hover:bg-slate-50 dark:hover:bg-slate-800/50 group">
              <div>
                <div class="font-bold text-slate-800 dark:text-slate-200 mb-1 flex items-center gap-2">${getIcon('Box', 16, 'text-brand')} ${p.name}</div>
                <div class="text-xs text-slate-500 dark:text-slate-400">${p.device} · ${p.protocol}</div>
              </div>
              <button data-preset-idx="${i}" class="px-4 py-2 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 rounded-full text-sm font-bold hover:bg-brand hover:text-white dark:hover:bg-brand dark:hover:text-white transition-colors">추가</button>
            </div>`).join('')}
        </div>`;
      openModal(html, '프리셋 추가');
      document.getElementById('modal-root').onclick = (e) => {
        const target = e.target.closest('[data-preset-idx]');
        if(target) {
          const p = DEFAULT_PRESETS[target.dataset.presetIdx];
          state.rooms[rIdx].rows.push({ ...p, __rid: Math.random().toString(36).slice(2), isSlim: false });
          saveRooms(); renderAll();
          document.getElementById('modal-root').innerHTML = '';
        }
      };
    }

    function openPopover(anchor, html) {
      const root = document.getElementById('popover-root');
      const rect = anchor.getBoundingClientRect();
      root.innerHTML = `
        <div class="fixed inset-0 z-[60]" id="popover-backdrop"></div>
        <div class="fixed z-[70] bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-slate-100 dark:border-slate-700 p-1 flex flex-col min-w-[160px] animate-in fade-in zoom-in-95 duration-100"
             style="top: ${Math.min(window.innerHeight - 200, rect.bottom + 8)}px; left: ${Math.min(window.innerWidth - 180, Math.max(10, rect.left - 100))}px;">
           ${html}
        </div>`;
      document.getElementById('popover-backdrop').onclick = () => root.innerHTML = '';
      return root.querySelector('div.fixed.z-\\[70\\]');
    }

    function openGnbPopover(anchor) {
      const html = `
        <button id="act-reset" class="flex items-center gap-2 px-3 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-lg text-sm text-slate-700 dark:text-slate-200 font-medium text-left">${getIcon('RotateCcw', 16)} 초기화</button>
        <button id="act-theme" class="flex items-center gap-2 px-3 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-lg text-sm text-slate-700 dark:text-slate-200 font-medium text-left">${getIcon('Moon', 16)} ${state.theme === 'dark' ? '라이트 모드' : '다크 모드'}</button>`;
      openPopover(anchor, html);
      document.getElementById('act-reset').onclick = () => { if(confirm('초기화?')) { localStorage.clear(); location.reload(); } };
      document.getElementById('act-theme').onclick = () => {
        state.theme = state.theme === 'light' ? 'dark' : 'light';
        saveTheme(state.theme); applyTheme();
        document.getElementById('popover-root').innerHTML = '';
      };
    }

    function openRoomPopover(anchor, rIdx) {
      const html = `
        <button data-a="preset" class="flex items-center gap-2 px-3 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-lg text-sm text-slate-700 dark:text-slate-200 font-medium text-left">${getIcon('Box', 16)} 프리셋 추가</button>
        <button data-a="clear" class="flex items-center gap-2 px-3 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-lg text-sm text-slate-700 dark:text-slate-200 font-medium text-left">${getIcon('RotateCcw', 16)} 방 비우기</button>
        <div class="h-[1px] bg-slate-100 dark:bg-slate-700 my-1"></div>
        <button data-a="remove" class="flex items-center gap-2 px-3 py-2 hover:bg-red-50 dark:hover:bg-red-900/20 text-red-500 rounded-lg text-sm font-medium text-left">${getIcon('Trash2', 16)} 방 삭제</button>`;
      const el = openPopover(anchor, html);
      el.onclick = (e) => {
        const act = e.target.closest('button')?.dataset.a;
        if(act === 'clear' && confirm('비우시겠습니까?')) { state.rooms[rIdx].rows = []; saveRooms(); renderAll(); }
        else if(act === 'remove' && confirm('삭제하시겠습니까?')) { state.rooms.splice(rIdx, 1); saveRooms(); renderAll(); }
        else if(act === 'preset') { openPresetModal(rIdx); }
        document.getElementById('popover-root').innerHTML = '';
      };
    }

    function openRowPopover(anchor, rIdx, rowId) {
      const rowIdx = state.rooms[rIdx].rows.findIndex(r => r.__rid === rowId);
      const html = `
        <button data-a="move" class="flex items-center gap-2 px-3 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-lg text-sm text-slate-700 dark:text-slate-200 font-medium text-left">${getIcon('LogOut', 16)} 방 옮기기</button>
        <button data-a="up" class="flex items-center gap-2 px-3 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-lg text-sm text-slate-700 dark:text-slate-200 font-medium text-left">${getIcon('ArrowUp', 16)} 위로</button>
        <button data-a="down" class="flex items-center gap-2 px-3 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-lg text-sm text-slate-700 dark:text-slate-200 font-medium text-left">${getIcon('ArrowDown', 16)} 아래로</button>
        <div class="h-[1px] bg-slate-100 dark:bg-slate-700 my-1"></div>
        <button data-a="dup" class="flex items-center gap-2 px-3 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-lg text-sm text-slate-700 dark:text-slate-200 font-medium text-left">${getIcon('Copy', 16)} 복제</button>
        <button data-a="del" class="flex items-center gap-2 px-3 py-2 hover:bg-red-50 dark:hover:bg-red-900/20 text-red-500 rounded-lg text-sm font-medium text-left">${getIcon('Trash2', 16)} 삭제</button>`;
      const el = openPopover(anchor, html);
      el.onclick = (e) => {
        const act = e.target.closest('button')?.dataset.a;
        const rows = state.rooms[rIdx].rows;
        if(act === 'del') rows.splice(rowIdx, 1);
        else if(act === 'dup') rows.splice(rowIdx+1, 0, {...rows[rowIdx], __rid: Math.random().toString(36).slice(2)});
        else if(act === 'up' && rowIdx > 0) { const [it] = rows.splice(rowIdx, 1); rows.splice(rowIdx-1, 0, it); }
        else if(act === 'down' && rowIdx < rows.length-1) { const [it] = rows.splice(rowIdx, 1); rows.splice(rowIdx+1, 0, it); }
        else if(act === 'move') {
          const htmlMove = state.rooms.map((r, i) => `<label class="flex items-center gap-3 p-4 rounded-xl hover:bg-blue-50 dark:hover:bg-slate-800 cursor-pointer"><input type="radio" name="troom" value="${i}" ${i===rIdx?'disabled':''}> ${r.name}</label>`).join('');
          openModal(htmlMove, '방 옮기기');
          const modalRoot = document.getElementById('modal-root');
          modalRoot.onchange = (ev) => {
            if(ev.target.name === 'troom') {
               const targetIdx = Number(ev.target.value);
               const [it] = state.rooms[rIdx].rows.splice(rowIdx, 1);
               state.rooms[targetIdx].rows.push(it);
               saveRooms(); renderAll(); modalRoot.innerHTML = '';
            }
          };
        }
        if(act !== 'move') { saveRooms(); renderAll(); }
        document.getElementById('popover-root').innerHTML = '';
      };
    }

    function setupIndicatorObserver() {
      const handleScroll = () => {
        // Track rows (both tr and slim divs)
        const rows = document.querySelectorAll('.row-tracker');
        const mapView = document.getElementById('map-view-area');
        const newVisible = new Set();
        const viewTop = window.scrollY;
        const viewBottom = viewTop + window.innerHeight;

        rows.forEach(row => {
          const rect = row.getBoundingClientRect();
          const top = rect.top + window.scrollY;
          const bottom = rect.bottom + window.scrollY;
          if (bottom > viewTop + 100 && top < viewBottom - 100) newVisible.add(row.dataset.rowId);
        });

        if (mapView) {
            const rect = mapView.getBoundingClientRect();
            if (rect.bottom > 0 && rect.top < window.innerHeight) {
                newVisible.add('map-view');
            }
        }

        if(newVisible.size !== state.visibleRowIds.size || [...newVisible].some(x => !state.visibleRowIds.has(x))) {
           state.visibleRowIds = newVisible; renderIndicators();
        }
      };
      window.addEventListener('scroll', handleScroll, { passive: true });
    }
// [수정] PNG 내보내기 함수 (Layout Shift 문제 해결 버전)
    const exportToPNG = async () => {
      if (!window.htmlToImage) return alert('html-to-image 라이브러리가 로드되지 않았습니다.');
      
      const btn = document.getElementById('btn-export-mobile');
      const originalText = btn.innerHTML;
      
      // 로딩 표시
      btn.innerHTML = `${getIcon('Camera', 20, 'animate-pulse')} <span class="font-bold text-xs">캡처중...</span>`;
      
      // [핵심 1] 캡처 도중 레이아웃이 밀릴 때 애니메이션이 발생하면 좌표가 꼬입니다.
      // 캡처 순간에만 모든 트랜지션을 강제로 끕니다.
      const style = document.createElement('style');
      style.id = 'capture-style-override';
      style.innerHTML = `
        * { 
           transition: none !important; 
           animation: none !important; 
        }
      `;
      document.head.appendChild(style);

      // 1. 화면 정리 (UI 숨기기)
      const noPrints = document.querySelectorAll('.no-print-target');
      noPrints.forEach(el => {
          if (el.id !== 'btn-export-mobile' && el.id !== 'btn-tuto-mobile') {
              el.dataset.prevDisplay = el.style.display; // 원래 display 상태 저장
              el.style.display = 'none';
          }
      });

      document.body.classList.add('no-scrollbar');
      
      // 2. 글래스모피즘 제거
      const glassEls = document.querySelectorAll('.glass, .backdrop-blur-md, .backdrop-blur-sm');
      glassEls.forEach(el => {
          el.dataset.prevFilter = el.style.backdropFilter;
          el.style.backdropFilter = 'none';
      });

      // 3. 캡처 전용 헤더 추가
      const captureHeader = document.createElement('div');
      captureHeader.id = 'capture-header-temp';
      captureHeader.className = "w-full flex flex-col items-center justify-center py-10 mb-4 bg-transparent";
      captureHeader.innerHTML = `
        <div class="flex items-center gap-3 mb-2">
            <div class="w-12 h-12 flex items-center justify-center overflow-hidden">
          <img src="images/icons/general/logo_shoppingthings_512h.png" alt="ShoppingThings" class="w-full h-full object-cover" onerror="this.style.display='none';this.parentElement.innerText='ST'">
        </div>
            <h1 class="font-logo font-bold text-3xl tracking-wide text-slate-900 dark:text-white">ShoppingThings</h1>
        </div>
        <p class="text-slate-500 font-medium">내가 만든 스마트홈 디바이스 쇼핑리스트</p>
      `;
      
      const mainContent = document.getElementById('main-content');
      // 헤더 삽입
      mainContent.insertBefore(captureHeader, mainContent.firstChild);

      // [핵심 2] 브라우저가 변경된 레이아웃(헤더 삽입으로 인한 밀림)을 
      // 확실하게 그릴 시간을 줍니다 (100ms 딜레이).
      // 트랜지션을 껐으므로 즉시 이동하지만, 렌더링 안정성을 위해 필요합니다.
      await new Promise(resolve => setTimeout(resolve, 100));

      // 4. 로딩 안 된 이미지 처리
      const images = document.querySelectorAll('img');
      const brokenImages = [];
      images.forEach(img => {
          if (img.naturalWidth === 0 || img.src === '' || img.style.display === 'none') {
              const originalDisplay = img.style.display;
              img.dataset.originalDisplay = originalDisplay;
              img.style.display = 'none'; 
              brokenImages.push(img);
          }
      });

      // 5. Input 값 텍스트 변환 (Overlay)
      // [중요] 레이아웃이 확정된(딜레이 후) 시점에 좌표를 계산해야 정확합니다.
      const inputs = document.querySelectorAll('input');
      const overlays = [];
      inputs.forEach(el => {
        const rect = el.getBoundingClientRect();
        if(rect.width === 0 || el.type === 'hidden' || el.style.display === 'none') return;
        
        const span = document.createElement('div');
        span.textContent = el.value;
        const style = window.getComputedStyle(el);
        Object.assign(span.style, {
           position: 'absolute', 
           // window.scrollX/Y를 더해서 절대 좌표 보정
           left: (rect.left + window.scrollX)+'px', 
           top: (rect.top + window.scrollY)+'px', 
           width: rect.width+'px', 
           height: rect.height+'px',
           zIndex: '99999', 
           background: 'transparent', 
           fontSize: style.fontSize, 
           fontWeight: style.fontWeight, 
           fontFamily: style.fontFamily,
           textAlign: style.textAlign, 
           padding: style.padding, 
           lineHeight: style.lineHeight, 
           color: style.color, 
           display: 'flex', 
           alignItems: 'center', 
           justifyContent: el.classList.contains('text-center')?'center':'flex-start', 
           pointerEvents: 'none'
        });
        document.body.appendChild(span);
        overlays.push({el, span});
        el.style.visibility = 'hidden';
      });

      // 6. 워터마크 추가
      const tile = document.createElement('div');
      Object.assign(tile.style, { position: 'absolute', left: '0', top: '0', width: document.documentElement.scrollWidth+'px', height: document.documentElement.scrollHeight+'px', pointerEvents: 'none', zIndex: '99998', display: 'flex', flexWrap: 'wrap', overflow: 'hidden' });
      
      for(let i=0; i<200; i++) {
        const t = document.createElement('div');
        t.textContent = 'ShoppingThings';
        Object.assign(t.style, { opacity: '0.01', fontSize: '36px', transform: 'rotate(-12deg)', margin: '8px', fontFamily: 'SamsungSharpSans', fontWeight: 'bold' });
        tile.appendChild(t);
      }
      document.body.appendChild(tile);

      // 정리 함수
      const cleanup = () => {
         // UI 복구
         noPrints.forEach(el => {
             if(el.dataset.prevDisplay) el.style.display = el.dataset.prevDisplay;
             else el.style.removeProperty('display');
         });
         document.body.classList.remove('no-scrollbar');
         
         glassEls.forEach(el => {
             if(el.dataset.prevFilter) el.style.backdropFilter = el.dataset.prevFilter;
             else el.style.removeProperty('backdrop-filter');
         });

         overlays.forEach(o => { o.el.style.visibility = ''; o.span.remove(); });
         
         if(captureHeader) captureHeader.remove();
         
         brokenImages.forEach(img => {
             img.style.display = img.dataset.originalDisplay || '';
         });
         
         tile.remove();
         if(style) style.remove(); // 스타일 오버라이드 제거 (애니메이션 복구)
         btn.innerHTML = originalText;
      };

      try {
        const dateStr = new Date().toISOString().slice(0,10).replace(/-/g,'');
        
        const filterNode = (node) => {
           if (node.id === 'btn-export-mobile' || node.id === 'btn-tuto-mobile') return false;
           return !node.classList?.contains('no-print-target');
        };

        const options = { 
            backgroundColor: state.theme === 'dark' ? '#0f172a' : '#f8fafc',
            cacheBust: true,
            useCORS: true,       
            skipOnError: true,
            filter: filterNode,
            pixelRatio: 2 // 해상도 2배 (선명하게)
        };

        // 캡처 전에 스크롤을 맨 위로 올려야 헤더가 잘리지 않을 수 있습니다.
        // (선택 사항: 사용자 경험상 튈 수 있으나 캡처 정확도는 올라감)
        // window.scrollTo(0, 0); 

        const blob = await htmlToImage.toBlob(document.body, options);
        
        if (!blob) throw new Error('이미지 생성 결과가 비어있습니다.');
        downloadBlob(blob, `ShoppingThings_List_${dateStr}.png`);

      } catch(e) { 
        console.error("Export Error:", e);
        let msg = e.message || e;
        if (e.type === 'error') msg = '이미지 리소스 보안 에러';
        alert('저장 실패: ' + msg);
      } finally {
        cleanup();
      }
    };
    function downloadBlob(blob, filename) {
        if (!blob) throw new Error('Blob creation failed');
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
    }

    // BOOTSTRAP
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
